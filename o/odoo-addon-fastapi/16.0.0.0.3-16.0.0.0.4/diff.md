# Comparing `tmp/odoo_addon_fastapi-16.0.0.0.3-py3-none-any.whl.zip` & `tmp/odoo_addon_fastapi-16.0.0.0.4-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,38 +1,41 @@
-Zip file size: 165378 bytes, number of entries: 36
--rw-r--r--  2.0 unx    62389 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/README.rst
--rw-r--r--  2.0 unx       54 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/__init__.py
--rw-r--r--  2.0 unx      961 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/__manifest__.py
--rw-r--r--  2.0 unx      276 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/context.py
--rw-r--r--  2.0 unx     4505 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/dependencies.py
--rw-r--r--  2.0 unx      305 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/depends.py
--rw-r--r--  2.0 unx     2272 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/error_handlers.py
--rw-r--r--  2.0 unx     2484 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/fastapi_dispatcher.py
--rw-r--r--  2.0 unx      404 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/schemas.py
--rw-r--r--  2.0 unx     1867 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/demo/fastapi_endpoint_demo.xml
--rw-r--r--  2.0 unx     6371 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/i18n/fastapi.pot
--rw-r--r--  2.0 unx      112 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/models/__init__.py
--rw-r--r--  2.0 unx     9779 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/models/fastapi_endpoint.py
--rw-r--r--  2.0 unx     6182 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/models/fastapi_endpoint_demo.py
--rw-r--r--  2.0 unx      978 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/models/ir_rule.py
--rw-r--r--  2.0 unx     1712 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/models/res_lang.py
--rw-r--r--  2.0 unx       44 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/readme/CONTRIBUTORS.rst
--rw-r--r--  2.0 unx     2255 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/readme/DESCRIPTION.rst
--rw-r--r--  2.0 unx      709 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/readme/ROADMAP.rst
--rw-r--r--  2.0 unx    56584 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/readme/USAGE.rst
--rw-r--r--  2.0 unx     1058 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/security/fastapi_endpoint.xml
--rw-r--r--  2.0 unx     3338 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/security/ir_rule+acl.xml
--rw-r--r--  2.0 unx     1418 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/security/res_groups.xml
--rw-r--r--  2.0 unx    33245 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/static/description/endpoint_create.png
--rw-r--r--  2.0 unx    36542 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/static/description/icon.png
--rw-r--r--  2.0 unx   129974 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/static/description/index.html
--rw-r--r--  2.0 unx       59 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/tests/__init__.py
--rw-r--r--  2.0 unx     1500 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/tests/test_fastapi.py
--rw-r--r--  2.0 unx     5451 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/tests/test_fastapi_demo.py
--rw-r--r--  2.0 unx     5471 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/views/fastapi_endpoint.xml
--rw-r--r--  2.0 unx      873 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/views/fastapi_endpoint_demo.xml
--rw-r--r--  2.0 unx      466 b- defN 23-Jun-26 16:14 odoo/addons/fastapi/views/fastapi_menu.xml
--rw-r--r--  2.0 unx    63175 b- defN 23-Jun-26 16:14 odoo_addon_fastapi-16.0.0.0.3.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Jun-26 16:14 odoo_addon_fastapi-16.0.0.0.3.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 23-Jun-26 16:14 odoo_addon_fastapi-16.0.0.0.3.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     3484 b- defN 23-Jun-26 16:14 odoo_addon_fastapi-16.0.0.0.3.dist-info/RECORD
-36 files, 446394 bytes uncompressed, 159622 bytes compressed:  64.2%
+Zip file size: 168826 bytes, number of entries: 39
+-rw-r--r--  2.0 unx    64055 b- defN 23-Jun-28 11:20 odoo/addons/fastapi/README.rst
+-rw-r--r--  2.0 unx       54 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/__init__.py
+-rw-r--r--  2.0 unx      961 b- defN 23-Jun-28 11:20 odoo/addons/fastapi/__manifest__.py
+-rw-r--r--  2.0 unx      276 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/context.py
+-rw-r--r--  2.0 unx     4527 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/dependencies.py
+-rw-r--r--  2.0 unx      305 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/depends.py
+-rw-r--r--  2.0 unx     2272 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/error_handlers.py
+-rw-r--r--  2.0 unx     2484 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/fastapi_dispatcher.py
+-rw-r--r--  2.0 unx     1134 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/schemas.py
+-rw-r--r--  2.0 unx     1867 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/demo/fastapi_endpoint_demo.xml
+-rw-r--r--  2.0 unx     6371 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/i18n/fastapi.pot
+-rw-r--r--  2.0 unx      127 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/models/__init__.py
+-rw-r--r--  2.0 unx     9779 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/models/fastapi_endpoint.py
+-rw-r--r--  2.0 unx     3515 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/models/fastapi_endpoint_demo.py
+-rw-r--r--  2.0 unx      978 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/models/ir_rule.py
+-rw-r--r--  2.0 unx     1712 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/models/res_lang.py
+-rw-r--r--  2.0 unx       44 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/readme/CONTRIBUTORS.rst
+-rw-r--r--  2.0 unx     2255 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/readme/DESCRIPTION.rst
+-rw-r--r--  2.0 unx      709 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/readme/ROADMAP.rst
+-rw-r--r--  2.0 unx    58250 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/readme/USAGE.rst
+-rw-r--r--  2.0 unx       99 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/routers/__init__.py
+-rw-r--r--  2.0 unx     3067 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/routers/demo_router.py
+-rw-r--r--  2.0 unx     1058 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/security/fastapi_endpoint.xml
+-rw-r--r--  2.0 unx     3338 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/security/ir_rule+acl.xml
+-rw-r--r--  2.0 unx     1418 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/security/res_groups.xml
+-rw-r--r--  2.0 unx    33245 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/static/description/endpoint_create.png
+-rw-r--r--  2.0 unx    36542 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/static/description/icon.png
+-rw-r--r--  2.0 unx   133832 b- defN 23-Jun-28 11:20 odoo/addons/fastapi/static/description/index.html
+-rw-r--r--  2.0 unx       59 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/tests/__init__.py
+-rw-r--r--  2.0 unx     4774 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/tests/common.py
+-rw-r--r--  2.0 unx     1510 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/tests/test_fastapi.py
+-rw-r--r--  2.0 unx     5299 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/tests/test_fastapi_demo.py
+-rw-r--r--  2.0 unx     5471 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/views/fastapi_endpoint.xml
+-rw-r--r--  2.0 unx      873 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/views/fastapi_endpoint_demo.xml
+-rw-r--r--  2.0 unx      466 b- defN 23-Jun-28 11:19 odoo/addons/fastapi/views/fastapi_menu.xml
+-rw-r--r--  2.0 unx    64841 b- defN 23-Jun-28 11:20 odoo_addon_fastapi-16.0.0.0.4.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Jun-28 11:20 odoo_addon_fastapi-16.0.0.0.4.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 23-Jun-28 11:20 odoo_addon_fastapi-16.0.0.0.4.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     3770 b- defN 23-Jun-28 11:20 odoo_addon_fastapi-16.0.0.0.4.dist-info/RECORD
+39 files, 461434 bytes uncompressed, 162610 bytes compressed:  64.8%
```

## zipnote {}

```diff
@@ -54,14 +54,20 @@
 
 Filename: odoo/addons/fastapi/readme/ROADMAP.rst
 Comment: 
 
 Filename: odoo/addons/fastapi/readme/USAGE.rst
 Comment: 
 
+Filename: odoo/addons/fastapi/routers/__init__.py
+Comment: 
+
+Filename: odoo/addons/fastapi/routers/demo_router.py
+Comment: 
+
 Filename: odoo/addons/fastapi/security/fastapi_endpoint.xml
 Comment: 
 
 Filename: odoo/addons/fastapi/security/ir_rule+acl.xml
 Comment: 
 
 Filename: odoo/addons/fastapi/security/res_groups.xml
@@ -75,14 +81,17 @@
 
 Filename: odoo/addons/fastapi/static/description/index.html
 Comment: 
 
 Filename: odoo/addons/fastapi/tests/__init__.py
 Comment: 
 
+Filename: odoo/addons/fastapi/tests/common.py
+Comment: 
+
 Filename: odoo/addons/fastapi/tests/test_fastapi.py
 Comment: 
 
 Filename: odoo/addons/fastapi/tests/test_fastapi_demo.py
 Comment: 
 
 Filename: odoo/addons/fastapi/views/fastapi_endpoint.xml
@@ -90,20 +99,20 @@
 
 Filename: odoo/addons/fastapi/views/fastapi_endpoint_demo.xml
 Comment: 
 
 Filename: odoo/addons/fastapi/views/fastapi_menu.xml
 Comment: 
 
-Filename: odoo_addon_fastapi-16.0.0.0.3.dist-info/METADATA
+Filename: odoo_addon_fastapi-16.0.0.0.4.dist-info/METADATA
 Comment: 
 
-Filename: odoo_addon_fastapi-16.0.0.0.3.dist-info/WHEEL
+Filename: odoo_addon_fastapi-16.0.0.0.4.dist-info/WHEEL
 Comment: 
 
-Filename: odoo_addon_fastapi-16.0.0.0.3.dist-info/top_level.txt
+Filename: odoo_addon_fastapi-16.0.0.0.4.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo_addon_fastapi-16.0.0.0.3.dist-info/RECORD
+Filename: odoo_addon_fastapi-16.0.0.0.4.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/fastapi/README.rst

```diff
@@ -200,17 +200,22 @@
     demo_api_router = APIRouter()
 
 Now, you can start adding routes to your router. For example, let's add a route
 that returns a list of partners.
 
 .. code-block:: python
 
+    from typing import Annotated
+
     from fastapi import APIRouter
     from pydantic import BaseModel
+
     from odoo import api, fields, models
+    from odoo.api import Environment
+
     from odoo.addons.fastapi.dependencies import odoo_env
 
     class FastapiEndpoint(models.Model):
 
         _inherit = "fastapi.endpoint"
 
         app: str = fields.Selection(
@@ -226,15 +231,15 @@
     demo_api_router = APIRouter()
 
     class PartnerInfo(BaseModel):
         name: str
         email: str
 
     @demo_api_router.get("/partners", response_model=list[PartnerInfo])
-    def get_partners(env=Depends(odoo_env)) -> list[PartnerInfo]:
+    def get_partners(env: Annotated[Environment, Depends(odoo_env)]) -> list[PartnerInfo]:
         return [
             PartnerInfo(name=partner.name, email=partner.email)
             for partner in env["res.partner"].search([])
         ]
 
 Now, you can start your Odoo server, install your addon and create a new endpoint
 instance for your app. Once it's done click on the docs url to access the
@@ -298,18 +303,21 @@
 The **'odoo.addons.fastapi.dependencies'** module provides a set of functions that you can use
 to inject reusable dependencies into your routes. For example, the **'odoo_env'**
 function returns the current odoo environment. You can use it to access the
 odoo models and the database from your route handlers.
 
 .. code-block:: python
 
+    from typing import Annotated
+
+    from odoo.api import Environment
     from odoo.addons.fastapi.dependencies import odoo_env
 
     @demo_api_router.get("/partners", response_model=list[PartnerInfo])
-    def get_partners(env=Depends(odoo_env)) -> list[PartnerInfo]:
+    def get_partners(env: Annotated[Environment, Depends(odoo_env)]) -> list[PartnerInfo]:
         return [
             PartnerInfo(name=partner.name, email=partner.email)
             for partner in env["res.partner"].search([])
         ]
 
 As you can see, you can use the **'Depends'** function to inject the dependency
 into your route handler. The **'Depends'** function is provided by the
@@ -361,16 +369,16 @@
         available for your endpoint method. To get the fastapi.endpoint record
         in your method, you just need to add a dependency on the fastapi_endpoint method
         defined below
         """
 
 
     def fastapi_endpoint(
-        _id: int = Depends(fastapi_endpoint_id),  # noqa: B008
-        env: Environment = Depends(odoo_env),  # noqa: B008
+        _id: Annotated[int, Depends(fastapi_endpoint_id)],
+        env: Annotated[Environment, Depends(odoo_env)],
     ) -> "FastapiEndpoint":
         """Return the fastapi.endpoint record"""
         return env["fastapi.endpoint"].browse(_id)
 
 
 As you can see, one of these dependencies is the **'fastapi_endpoint_id'**
 dependency and has no concrete implementation. This method is used as a contract
@@ -405,17 +413,20 @@
 **'fastapi_endpoint'** this dependency depends on an abstract dependency.
 
 When you define a route handler, you can inject the **'authenticated_partner'**
 dependency as a parameter of your route handler.
 
 .. code-block:: python
 
+    from odoo.addons.base.models.res_partner import Partner
+
+
     @demo_api_router.get("/partners", response_model=list[PartnerInfo])
     def get_partners(
-        env=Depends(odoo_env), partner=Depends(authenticated_partner)
+        env: Annotated[Environment, Depends(odoo_env)], partner: Annotated[Partner, Depends(authenticated_partner)]
     ) -> list[PartnerInfo]:
         return [
             PartnerInfo(name=partner.name, email=partner.email)
             for partner in env["res.partner"].search([])
         ]
 
 
@@ -426,16 +437,16 @@
 'BasicAuth' method. This authentication mechanism is implemented in the
 **'odoo.addons.fastapi.dependencies'** module and relies on functionalities provided
 by the **'fastapi.security'** module.
 
 .. code-block:: python
 
       def authenticated_partner(
-          env: Environment = Depends(odoo_env),
-          security: HTTPBasicCredentials = Depends(HTTPBasic()),
+          env: Annotated[Environment, Depends(odoo_env)],
+          security: Annotated[HTTPBasicCredentials, Depends(HTTPBasic())],
       ) -> "res.partner":
           """Return the authenticated partner"""
           partner = env["res.partner"].search(
               [("email", "=", security.username)], limit=1
           )
           if not partner:
               raise HTTPException(
@@ -470,21 +481,21 @@
 implemented, we will only implement the api key authentication mechanism.
 
 .. code-block:: python
 
   from fastapi.security import APIKeyHeader
 
   def api_key_based_authenticated_partner_impl(
-      api_key: str = Depends(  # noqa: B008
+      api_key: Annotated[str, Depends(
           APIKeyHeader(
               name="api-key",
               description="In this demo, you can use a user's login as api key.",
           )
-      ),
-      env: Environment = Depends(odoo_env),  # noqa: B008
+      )],
+      env: Annotated[Environment, Depends(odoo_env)],
   ) -> Partner:
       """A dummy implementation that look for a user with the same login
       as the provided api key
       """
       partner = env["res.users"].search([("login", "=", api_key)], limit=1).partner_id
       if not partner:
           raise HTTPException(
@@ -598,15 +609,15 @@
 
     @demo_api_router.get(
         "/endpoint_app_info",
         response_model=EndpointAppInfo,
         dependencies=[Depends(authenticated_partner)],
     )
     async def endpoint_app_info(
-        endpoint: FastapiEndpoint = Depends(fastapi_endpoint),  # noqa: B008
+        endpoint: Annotated[FastapiEndpoint, Depends(fastapi_endpoint)],
     ) -> EndpointAppInfo:
         """Returns the current endpoint configuration"""
         # This method show you how to get access to current endpoint configuration
         # It also show you how you can specify a dependency to force the security
         # even if the method doesn't require the authenticated partner as parameter
         return EndpointAppInfo.from_orm(endpoint)
 
@@ -724,15 +735,15 @@
   @demo_api_router.get(
       "/echo",
       response_model=EchoResponse,
       dependencies=[Depends(odoo_env)],
   )
   async def echo(
       message: str,
-      odoo_env: OdooEnv = Depends(odoo_env),
+      odoo_env: Annotated[Environment, Depends(odoo_env)],
   ) -> EchoResponse:
       """Echo the message"""
       return EchoResponse(message=odoo_env["demo.fastapi.endpoint"].echo(message))
 
   class EchoResponse(BaseModel):
       message: str
 
@@ -789,15 +800,15 @@
   @demo_api_router.get(
       "/echo2",
       response_model=EchoResponse,
       dependencies=[Depends(odoo_env)],
   )
   async def echo2(
       message: str,
-      odoo_env: OdooEnv = Depends(odoo_env),
+      odoo_env: Annotated[Environment, Depends(odoo_env)],
   ) -> EchoResponse:
       """Echo the message"""
       echo = odoo_env["demo.fastapi.endpoint"].echo2(message)
       return EchoResponse(message=f"Echo2: {echo}")
 
 The problem with this approach is that you unconditionally add the new route
 handler to the existing app even if the app is called for a different database
@@ -824,15 +835,15 @@
   @additional_demo_api_router.get(
       "/echo2",
       response_model=EchoResponse,
       dependencies=[Depends(odoo_env)],
   )
   async def echo2(
       message: str,
-      odoo_env: OdooEnv = Depends(odoo_env),
+      odoo_env: Annotated[Environment, Depends(odoo_env)],
   ) -> EchoResponse:
       """Echo the message"""
       echo = odoo_env["demo.fastapi.endpoint"].echo2(message)
       return EchoResponse(message=f"Echo2: {echo}")
 
 
 In this way, the new router is added to the list of routers of your app only if
@@ -871,15 +882,15 @@
 
   @demo_api_router.get(
       "/partner",
       response_model=Location,
       dependencies=[Depends(authenticated_partner)],
   )
   async def partner(
-      partner: ResPartner = Depends(authenticated_partner),
+      partner: Annotated[ResPartner, Depends(authenticated_partner)],
   ) -> Partner:
       """Return the location"""
       return Partner.from_orm(partner)
 
 
 If you need to add a new field into the model **'Partner'**, you can extend it
 in your new addon by defining a new model that inherits from the model **'Partner'**.
@@ -1002,57 +1013,71 @@
 Once again the dependency injection mechanism comes to the rescue by allowing
 you to inject into the test client specific implementations of the dependencies
 normally provided by the normal processing of the request by the fastapi app.
 (for example, you can inject a mock of the dependency 'authenticated_partner'
 to test the behavior of your route handlers when the partner is not authenticated,
 you can also inject a mock for the odoo_env etc...)
 
-With all these features, writing a test for the 'Hello world' route handler
-defined into the demo app is as simple as
+The fastapi addon provides a base class for the test cases that you can use to
+write your tests. This base class is **'odoo.fastapi.tests.common.FastAPITransactionCase'**.
+This class mainly provides the method **'_create_test_client'** that you can
+use to create a test client for your fastapi app. This method encapsulates the
+creation of the test client and the injection of the dependencies. It also
+ensures that the odoo environment is make available into the context of the
+route handlers. This method is designed to be used when you need to test your
+app or when you need to test a specific router (It's therefore easy to defines
+tests for routers in an addon that doesn't provide a fastapi endpoint).
+
+With this base class, writing a test for a route handler is as simple as:
 
 .. code-block:: python
 
-  from functools import partial
+  from odoo.fastapi.tests.common import FastAPITransactionCase
 
-  from requests import Response
+  from odoo.addons.fastapi import dependencies
+  from odoo.addons.fastapi.routers import demo_router
 
-  from odoo.tests.common import TransactionCase
+  class FastAPIDemoCase(FastAPITransactionCase):
 
-  from fastapi.testclient import TestClient
+      @classmethod
+      def setUpClass(cls) -> None:
+          super().setUpClass()
+          cls.default_fastapi_running_user = cls.env.ref("fastapi.my_demo_app_user")
+          cls.default_fastapi_authenticated_partner = cls.env["res.partner"].create({"name": "FastAPI Demo"})
 
-  from .. import dependencies
-  from ..context import odoo_env_ctx
+      def test_hello_world(self) -> None:
+          with self._create_test_client(router=demo_router) as test_client:
+              response: Response = test_client.get("/demo/")
+          self.assertEqual(response.status_code, status.HTTP_200_OK)
+          self.assertDictEqual(response.json(), {"Hello": "World"})
 
 
-  class FastAPIDemoCase(TransactionCase):
+In the previous example, we created a test client for the demo_router. We could
+have created a test client for the whole app by not specifying the router but
+the app instead.
 
-      @classmethod
-      def setUpClass(cls) -> None:
-          super().setUpClass()
-          cls.test_partner = cls.env["res.partner"].create({"name": "FastAPI Demo"})
-          cls.fastapi_demo_app = cls.env.ref("fastapi.fastapi_endpoint_demo")
-          cls.app = cls.fastapi_demo_app._get_app()
-          cls.app.dependency_overrides[dependencies.authenticated_partner_impl] = partial(
-              lambda a: a, cls.test_partner
-          )
-          cls.client = TestClient(cls.app)
-          cls._ctx_token = odoo_env_ctx.set(cls.env)
+.. code-block:: python
 
-      @classmethod
-      def tearDownClass(cls) -> None:
-          odoo_env_ctx.reset(cls._ctx_token)
-          cls.fastapi_demo_app._reset_app()
+  from odoo.fastapi.tests.common import FastAPITransactionCase
+
+  from odoo.addons.fastapi import dependencies
+  from odoo.addons.fastapi.routers import demo_router
 
-          super().tearDownClass()
+  class FastAPIDemoCase(FastAPITransactionCase):
 
-      def _get_path(self, path) -> str:
-          return self.fastapi_demo_app.root_path + path
+      @classmethod
+      def setUpClass(cls) -> None:
+          super().setUpClass()
+          cls.default_fastapi_running_user = cls.env.ref("fastapi.my_demo_app_user")
+          cls.default_fastapi_authenticated_partner = cls.env["res.partner"].create({"name": "FastAPI Demo"})
 
       def test_hello_world(self) -> None:
-          response: Response = self.client.get(self._get_path("/"))
+          demo_endpoint = self.env.ref("fastapi.fastapi_endpoint_demo")
+          with self._create_test_client(app=demo_endpoint._get_app()) as test_client:
+              response: Response = test_client.get(f"{demo_endpoint.root_path}/demo/")
           self.assertEqual(response.status_code, status.HTTP_200_OK)
           self.assertDictEqual(response.json(), {"Hello": "World"})
 
 
 Overall considerations when you develop an fastapi app
 *******************************************************
 
@@ -1199,14 +1224,15 @@
 1. A dependency method to use to specify the pagination parameters in the same
    way for all the search route handlers: **'odoo.addons.fastapi.paging'**.
 2. A PagedCollection pydantic model to use to return the result of a search route
    handler enclosed in a json document that contains the total number of records.
 
 .. code-block:: python
 
+    from typing import Annotated
     from pydantic import BaseModel
 
     from odoo.api import Environment
     from odoo.addons.fastapi.dependencies import paging, authenticated_partner_env
     from odoo.addons.fastapi.schemas import PagedCollection, Paging
 
     class SaleOrder(BaseModel):
@@ -1216,16 +1242,16 @@
 
     @router.get(
         "/sale_orders",
         response_model=PagedCollection[SaleOrder],
         response_model_exclude_unset=True,
     )
     def get_sale_orders(
-        paging: Paging = Depends(paging),
-        env: Environment = Depends(authenticated_partner_env),
+        paging: Annotated[Paging, Depends(paging)],
+        env: Annotated[Environment, Depends(authenticated_partner_env)],
     ) -> PagedCollection[SaleOrder]:
         """Get the list of sale orders."""
         count = env["sale.order"].search_count([])
         orders = env["sale.order"].search([], limit=paging.limit, offset=paging.offset)
         return PagedCollection[SaleOrder](
             total=count,
             items=[SaleOrder.from_orm(order) for order in orders],
```

## odoo/addons/fastapi/__manifest__.py

```diff
@@ -1,15 +1,15 @@
 # Copyright 2022 ACSONE SA/NV
 # License LGPL-3.0 or later (http://www.gnu.org/licenses/LGPL).
 
 {
     "name": "Odoo FastAPI",
     "summary": """
         Odoo FastAPI endpoint""",
-    "version": "16.0.0.0.3",
+    "version": "16.0.0.0.4",
     "license": "LGPL-3",
     "author": "ACSONE SA/NV,Odoo Community Association (OCA)",
     "maintainers": ["lmignon"],
     "website": "https://github.com/OCA/rest-framework",
     "depends": ["endpoint_route_handler"],
     "data": [
         "security/res_groups.xml",
```

## odoo/addons/fastapi/dependencies.py

```diff
@@ -1,11 +1,11 @@
 # Copyright 2022 ACSONE SA/NV
 # License LGPL-3.0 or later (http://www.gnu.org/licenses/LGPL).
 
-from typing import TYPE_CHECKING
+from typing import TYPE_CHECKING, Annotated
 
 from odoo.api import Environment
 from odoo.exceptions import AccessDenied
 
 from odoo.addons.base.models.res_partner import Partner
 from odoo.addons.base.models.res_users import Users
 
@@ -28,46 +28,46 @@
     to declare the way your partner will be provided. In some case, this
     partner will come from the authentication mechanism (ex jwt token) in other cases
     it could comme from a lookup on an email received into an HTTP header ...
     See the fastapi_endpoint_demo for an example"""
 
 
 def authenticated_partner_env(
-    partner: Partner = Depends(authenticated_partner_impl),  # noqa: B008
+    partner: Annotated[Partner, Depends(authenticated_partner_impl)]
 ) -> Environment:
     """Return an environment with the authenticated partner id in the context"""
     return partner.with_context(authenticated_partner_id=partner.id).env
 
 
 def authenticated_partner(
-    partner: Partner = Depends(authenticated_partner_impl),  # noqa: B008
-    partner_env: Environment = Depends(authenticated_partner_env),  # noqa: B008
+    partner: Annotated[Partner, Depends(authenticated_partner_impl)],
+    partner_env: Annotated[Environment, Depends(authenticated_partner_env)],
 ) -> Partner:
     """If you need to get access to the authenticated partner into your
     endpoint, you can add a dependency into the endpoint definition on this
     method.
     This method is a safe way to declare a dependency without requiring a
     specific implementation. It depends on `authenticated_partner_impl`. The
     concrete implementation of authenticated_partner_impl has to be provided
     when the FastAPI app is created.
     This method return a partner into the authenticated_partner_env
     """
     return partner_env["res.partner"].browse(partner.id)
 
 
 def paging(
-    page: int = Query(1, gte=1), page_size: int = Query(80, gte=1)  # noqa: B008
+    page: Annotated[int, Query(gte=1)] = 1, page_size: Annotated[int, Query(gte=1)] = 80
 ) -> Paging:
     """Return a Paging object from the page and page_size parameters"""
     return Paging(limit=page_size, offset=(page - 1) * page_size)
 
 
 def basic_auth_user(
-    credential: HTTPBasicCredentials = Depends(HTTPBasic()),  # noqa: B008
-    env: Environment = Depends(odoo_env),  # noqa: B008
+    credential: Annotated[HTTPBasicCredentials, Depends(HTTPBasic())],
+    env: Annotated[Environment, Depends(odoo_env)],
 ) -> Users:
     username = credential.username
     password = credential.password
     try:
         uid = (
             env["res.users"]
             .sudo()
@@ -81,43 +81,45 @@
             status_code=status.HTTP_401_UNAUTHORIZED,
             detail="Incorrect username or password",
             headers={"WWW-Authenticate": "Basic"},
         ) from ad
 
 
 def authenticated_partner_from_basic_auth_user(
-    user: Users = Depends(basic_auth_user),  # noqa: B008
-    env: Environment = Depends(odoo_env),  # noqa: B008
+    user: Annotated[Users, Depends(basic_auth_user)],
+    env: Annotated[Environment, Depends(odoo_env)],
 ) -> Partner:
     return env["res.partner"].browse(user.sudo().partner_id.id)
 
 
 def fastapi_endpoint_id() -> int:
     """This method is overriden by the FastAPI app to make the fastapi.endpoint record
     available for your endpoint method. To get the fastapi.endpoint record
     in your method, you just need to add a dependency on the fastapi_endpoint method
     defined below
     """
 
 
 def fastapi_endpoint(
-    _id: int = Depends(fastapi_endpoint_id),  # noqa: B008
-    env: Environment = Depends(odoo_env),  # noqa: B008
+    _id: Annotated[int, Depends(fastapi_endpoint_id)],
+    env: Annotated[Environment, Depends(odoo_env)],
 ) -> "FastapiEndpoint":
     """Return the fastapi.endpoint record"""
     return env["fastapi.endpoint"].browse(_id)
 
 
 def accept_language(
-    accept_language: str = Header(  # noqa: B008
-        None,
-        alias="Accept-Language",
-        description="The Accept-Language header is used to specify the language "
-        "of the content to be returned. If a language is not available, the "
-        "server will return the content in the default language.",
-    )
+    accept_language: Annotated[
+        str | None,
+        Header(
+            alias="Accept-Language",
+            description="The Accept-Language header is used to specify the language "
+            "of the content to be returned. If a language is not available, the "
+            "server will return the content in the default language.",
+        ),
+    ] = None,
 ) -> str:
     """This dependency is used at application level to document the way the language
     to use for the response is specified. The header is processed outside of the
     fastapi app to initialize the odoo environment with the right language.
     """
     return accept_language
```

## odoo/addons/fastapi/schemas.py

```diff
@@ -1,20 +1,49 @@
 # Copyright 2022 ACSONE SA/NV
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl).
 
+from enum import Enum
 from typing import Generic, List, Optional, TypeVar
 
-from pydantic import BaseModel
+from pydantic import BaseModel, Field
 from pydantic.generics import GenericModel
 
 T = TypeVar("T")
 
 
 class PagedCollection(GenericModel, Generic[T]):
 
     total: int
     items: List[T]
 
 
 class Paging(BaseModel):
     limit: Optional[int]
     offset: Optional[int]
+
+
+#############################################################
+# here above you can find models only used for the demo app #
+#############################################################
+class DemoUserInfo(BaseModel):
+    name: str
+    display_name: str
+
+
+class DemoEndpointAppInfo(BaseModel):
+    id: str
+    name: str
+    app: str
+    auth_method: str = Field(alias="demo_auth_method")
+    root_path: str
+
+    class Config:
+        orm_mode = True
+
+
+class DemoExceptionType(str, Enum):
+    user_error = "UserError"
+    validation_error = "ValidationError"
+    access_error = "AccessError"
+    missing_error = "MissingError"
+    http_exception = "HTTPException"
+    bare_exception = "BareException"
```

## odoo/addons/fastapi/models/__init__.py

```diff
@@ -1,4 +1,4 @@
-from . import fastapi_endpoint
+from .fastapi_endpoint import FastapiEndpoint
 from . import fastapi_endpoint_demo
 from . import ir_rule
 from . import res_lang
```

## odoo/addons/fastapi/models/fastapi_endpoint_demo.py

```diff
@@ -1,29 +1,26 @@
 # Copyright 2022 ACSONE SA/NV
 # License LGPL-3.0 or later (http://www.gnu.org/licenses/LGPL).
-from enum import Enum
-from typing import List
+from typing import Annotated, Any, List
 
 from odoo import _, api, fields, models
 from odoo.api import Environment
-from odoo.exceptions import AccessError, MissingError, UserError, ValidationError
+from odoo.exceptions import ValidationError
 
 from odoo.addons.base.models.res_partner import Partner
 
 from fastapi import APIRouter, Depends, HTTPException, status
 from fastapi.security import APIKeyHeader
-from pydantic import BaseModel, Field
 
 from ..dependencies import (
-    authenticated_partner,
     authenticated_partner_from_basic_auth_user,
     authenticated_partner_impl,
-    fastapi_endpoint,
     odoo_env,
 )
+from ..routers import demo_router, demo_router_doc
 
 
 class FastapiEndpoint(models.Model):
 
     _inherit = "fastapi.endpoint"
 
     app: str = fields.Selection(
@@ -32,15 +29,15 @@
     demo_auth_method = fields.Selection(
         selection=[("api_key", "Api Key"), ("http_basic", "HTTP Basic")],
         string="Authenciation method",
     )
 
     def _get_fastapi_routers(self) -> List[APIRouter]:
         if self.app == "demo":
-            return [demo_api_router]
+            return [demo_router]
         return super()._get_fastapi_routers()
 
     @api.constrains("app", "demo_auth_method")
     def _valdiate_demo_auth_method(self):
         for rec in self:
             if rec.app == "demo" and not rec.demo_auth_method:
                 raise ValidationError(
@@ -70,116 +67,34 @@
                     api_key_based_authenticated_partner_impl
                 )
             app.dependency_overrides[
                 authenticated_partner_impl
             ] = authenticated_partner_impl_override
         return app
 
-
-class UserInfo(BaseModel):
-    name: str
-    display_name: str
-
-
-class EndpointAppInfo(BaseModel):
-    id: str
-    name: str
-    app: str
-    auth_method: str = Field(alias="demo_auth_method")
-    root_path: str
-
-    class Config:
-        orm_mode = True
-
-
-demo_api_router = APIRouter()
-
-
-@demo_api_router.get("/")
-async def hello_word():
-    """Hello World!"""
-    return {"Hello": "World"}
-
-
-class ExceptionType(str, Enum):
-    user_error = "UserError"
-    validation_error = "ValidationError"
-    access_error = "AccessError"
-    missing_error = "MissingError"
-    http_exception = "HTTPException"
-    bare_exception = "BareException"
-
-
-@demo_api_router.get("/exception")
-async def exception(exception_type: ExceptionType, error_message: str):
-    """Raise an exception
-
-    This method is used in the test suite to check that any exception
-    is correctly handled by the fastapi endpoint and that the transaction
-    is roll backed.
-    """
-    exception_classes = {
-        ExceptionType.user_error: UserError,
-        ExceptionType.validation_error: ValidationError,
-        ExceptionType.access_error: AccessError,
-        ExceptionType.missing_error: MissingError,
-        ExceptionType.http_exception: HTTPException,
-        ExceptionType.bare_exception: NotImplementedError,  # any exception child of Exception
-    }
-    exception_cls = exception_classes[exception_type]
-    if exception_cls is HTTPException:
-        raise exception_cls(status_code=status.HTTP_409_CONFLICT, detail=error_message)
-    raise exception_classes[exception_type](error_message)
-
-
-@demo_api_router.get("/lang")
-async def get_lang(env: Environment = Depends(odoo_env)):  # noqa: B008
-    """Returns the language according to the available languages in Odoo and the
-    Accept-Language header.
-
-    This method is used in the test suite to check that the language is correctly
-    set in the Odoo environment according to the Accept-Language header
-    """
-    return env.context.get("lang")
-
-
-@demo_api_router.get("/who_ami", response_model=UserInfo)
-async def who_ami(partner=Depends(authenticated_partner)) -> UserInfo:  # noqa: B008
-    """Who am I?
-
-    Returns the authenticated partner
-    """
-    # This method show you how you can rget the authenticated partner without
-    # depending on a specific implementation.
-    return UserInfo(name=partner.name, display_name=partner.display_name)
-
-
-@demo_api_router.get(
-    "/endpoint_app_info",
-    response_model=EndpointAppInfo,
-    dependencies=[Depends(authenticated_partner)],
-)
-async def endpoint_app_info(
-    endpoint: FastapiEndpoint = Depends(fastapi_endpoint),  # noqa: B008
-) -> EndpointAppInfo:
-    """Returns the current endpoint configuration"""
-    # This method show you how to get access to current endpoint configuration
-    # It also show you how you can specify a dependency to force the security
-    # even if the method doesn't require the authenticated partner as parameter
-    return EndpointAppInfo.from_orm(endpoint)
+    def _prepare_fastapi_app_params(self) -> dict[str, Any]:
+        params = super()._prepare_fastapi_app_params()
+        if self.app == "demo":
+            tags_metadata = params.get("openapi_tags", []) or []
+            tags_metadata.append({"name": "demo", "description": demo_router_doc})
+            params["openapi_tags"] = tags_metadata
+        return params
 
 
 def api_key_based_authenticated_partner_impl(
-    api_key: str = Depends(  # noqa: B008
-        APIKeyHeader(
-            name="api-key",
-            description="In this demo, you can use a user's login as api key.",
-        )
-    ),
-    env: Environment = Depends(odoo_env),  # noqa: B008
+    api_key: Annotated[
+        str,
+        Depends(
+            APIKeyHeader(
+                name="api-key",
+                description="In this demo, you can use a user's login as api key.",
+            )
+        ),
+    ],
+    env: Annotated[Environment, Depends(odoo_env)],
 ) -> Partner:
     """A dummy implementation that look for a user with the same login
     as the provided api key
     """
     partner = (
         env["res.users"].sudo().search([("login", "=", api_key)], limit=1).partner_id
     )
```

## odoo/addons/fastapi/readme/USAGE.rst

```diff
@@ -125,17 +125,22 @@
     demo_api_router = APIRouter()
 
 Now, you can start adding routes to your router. For example, let's add a route
 that returns a list of partners.
 
 .. code-block:: python
 
+    from typing import Annotated
+
     from fastapi import APIRouter
     from pydantic import BaseModel
+
     from odoo import api, fields, models
+    from odoo.api import Environment
+
     from odoo.addons.fastapi.dependencies import odoo_env
 
     class FastapiEndpoint(models.Model):
 
         _inherit = "fastapi.endpoint"
 
         app: str = fields.Selection(
@@ -151,15 +156,15 @@
     demo_api_router = APIRouter()
 
     class PartnerInfo(BaseModel):
         name: str
         email: str
 
     @demo_api_router.get("/partners", response_model=list[PartnerInfo])
-    def get_partners(env=Depends(odoo_env)) -> list[PartnerInfo]:
+    def get_partners(env: Annotated[Environment, Depends(odoo_env)]) -> list[PartnerInfo]:
         return [
             PartnerInfo(name=partner.name, email=partner.email)
             for partner in env["res.partner"].search([])
         ]
 
 Now, you can start your Odoo server, install your addon and create a new endpoint
 instance for your app. Once it's done click on the docs url to access the
@@ -223,18 +228,21 @@
 The **'odoo.addons.fastapi.dependencies'** module provides a set of functions that you can use
 to inject reusable dependencies into your routes. For example, the **'odoo_env'**
 function returns the current odoo environment. You can use it to access the
 odoo models and the database from your route handlers.
 
 .. code-block:: python
 
+    from typing import Annotated
+
+    from odoo.api import Environment
     from odoo.addons.fastapi.dependencies import odoo_env
 
     @demo_api_router.get("/partners", response_model=list[PartnerInfo])
-    def get_partners(env=Depends(odoo_env)) -> list[PartnerInfo]:
+    def get_partners(env: Annotated[Environment, Depends(odoo_env)]) -> list[PartnerInfo]:
         return [
             PartnerInfo(name=partner.name, email=partner.email)
             for partner in env["res.partner"].search([])
         ]
 
 As you can see, you can use the **'Depends'** function to inject the dependency
 into your route handler. The **'Depends'** function is provided by the
@@ -286,16 +294,16 @@
         available for your endpoint method. To get the fastapi.endpoint record
         in your method, you just need to add a dependency on the fastapi_endpoint method
         defined below
         """
 
 
     def fastapi_endpoint(
-        _id: int = Depends(fastapi_endpoint_id),  # noqa: B008
-        env: Environment = Depends(odoo_env),  # noqa: B008
+        _id: Annotated[int, Depends(fastapi_endpoint_id)],
+        env: Annotated[Environment, Depends(odoo_env)],
     ) -> "FastapiEndpoint":
         """Return the fastapi.endpoint record"""
         return env["fastapi.endpoint"].browse(_id)
 
 
 As you can see, one of these dependencies is the **'fastapi_endpoint_id'**
 dependency and has no concrete implementation. This method is used as a contract
@@ -330,17 +338,20 @@
 **'fastapi_endpoint'** this dependency depends on an abstract dependency.
 
 When you define a route handler, you can inject the **'authenticated_partner'**
 dependency as a parameter of your route handler.
 
 .. code-block:: python
 
+    from odoo.addons.base.models.res_partner import Partner
+
+
     @demo_api_router.get("/partners", response_model=list[PartnerInfo])
     def get_partners(
-        env=Depends(odoo_env), partner=Depends(authenticated_partner)
+        env: Annotated[Environment, Depends(odoo_env)], partner: Annotated[Partner, Depends(authenticated_partner)]
     ) -> list[PartnerInfo]:
         return [
             PartnerInfo(name=partner.name, email=partner.email)
             for partner in env["res.partner"].search([])
         ]
 
 
@@ -351,16 +362,16 @@
 'BasicAuth' method. This authentication mechanism is implemented in the
 **'odoo.addons.fastapi.dependencies'** module and relies on functionalities provided
 by the **'fastapi.security'** module.
 
 .. code-block:: python
 
       def authenticated_partner(
-          env: Environment = Depends(odoo_env),
-          security: HTTPBasicCredentials = Depends(HTTPBasic()),
+          env: Annotated[Environment, Depends(odoo_env)],
+          security: Annotated[HTTPBasicCredentials, Depends(HTTPBasic())],
       ) -> "res.partner":
           """Return the authenticated partner"""
           partner = env["res.partner"].search(
               [("email", "=", security.username)], limit=1
           )
           if not partner:
               raise HTTPException(
@@ -395,21 +406,21 @@
 implemented, we will only implement the api key authentication mechanism.
 
 .. code-block:: python
 
   from fastapi.security import APIKeyHeader
 
   def api_key_based_authenticated_partner_impl(
-      api_key: str = Depends(  # noqa: B008
+      api_key: Annotated[str, Depends(
           APIKeyHeader(
               name="api-key",
               description="In this demo, you can use a user's login as api key.",
           )
-      ),
-      env: Environment = Depends(odoo_env),  # noqa: B008
+      )],
+      env: Annotated[Environment, Depends(odoo_env)],
   ) -> Partner:
       """A dummy implementation that look for a user with the same login
       as the provided api key
       """
       partner = env["res.users"].search([("login", "=", api_key)], limit=1).partner_id
       if not partner:
           raise HTTPException(
@@ -523,15 +534,15 @@
 
     @demo_api_router.get(
         "/endpoint_app_info",
         response_model=EndpointAppInfo,
         dependencies=[Depends(authenticated_partner)],
     )
     async def endpoint_app_info(
-        endpoint: FastapiEndpoint = Depends(fastapi_endpoint),  # noqa: B008
+        endpoint: Annotated[FastapiEndpoint, Depends(fastapi_endpoint)],
     ) -> EndpointAppInfo:
         """Returns the current endpoint configuration"""
         # This method show you how to get access to current endpoint configuration
         # It also show you how you can specify a dependency to force the security
         # even if the method doesn't require the authenticated partner as parameter
         return EndpointAppInfo.from_orm(endpoint)
 
@@ -649,15 +660,15 @@
   @demo_api_router.get(
       "/echo",
       response_model=EchoResponse,
       dependencies=[Depends(odoo_env)],
   )
   async def echo(
       message: str,
-      odoo_env: OdooEnv = Depends(odoo_env),
+      odoo_env: Annotated[Environment, Depends(odoo_env)],
   ) -> EchoResponse:
       """Echo the message"""
       return EchoResponse(message=odoo_env["demo.fastapi.endpoint"].echo(message))
 
   class EchoResponse(BaseModel):
       message: str
 
@@ -714,15 +725,15 @@
   @demo_api_router.get(
       "/echo2",
       response_model=EchoResponse,
       dependencies=[Depends(odoo_env)],
   )
   async def echo2(
       message: str,
-      odoo_env: OdooEnv = Depends(odoo_env),
+      odoo_env: Annotated[Environment, Depends(odoo_env)],
   ) -> EchoResponse:
       """Echo the message"""
       echo = odoo_env["demo.fastapi.endpoint"].echo2(message)
       return EchoResponse(message=f"Echo2: {echo}")
 
 The problem with this approach is that you unconditionally add the new route
 handler to the existing app even if the app is called for a different database
@@ -749,15 +760,15 @@
   @additional_demo_api_router.get(
       "/echo2",
       response_model=EchoResponse,
       dependencies=[Depends(odoo_env)],
   )
   async def echo2(
       message: str,
-      odoo_env: OdooEnv = Depends(odoo_env),
+      odoo_env: Annotated[Environment, Depends(odoo_env)],
   ) -> EchoResponse:
       """Echo the message"""
       echo = odoo_env["demo.fastapi.endpoint"].echo2(message)
       return EchoResponse(message=f"Echo2: {echo}")
 
 
 In this way, the new router is added to the list of routers of your app only if
@@ -796,15 +807,15 @@
 
   @demo_api_router.get(
       "/partner",
       response_model=Location,
       dependencies=[Depends(authenticated_partner)],
   )
   async def partner(
-      partner: ResPartner = Depends(authenticated_partner),
+      partner: Annotated[ResPartner, Depends(authenticated_partner)],
   ) -> Partner:
       """Return the location"""
       return Partner.from_orm(partner)
 
 
 If you need to add a new field into the model **'Partner'**, you can extend it
 in your new addon by defining a new model that inherits from the model **'Partner'**.
@@ -927,57 +938,71 @@
 Once again the dependency injection mechanism comes to the rescue by allowing
 you to inject into the test client specific implementations of the dependencies
 normally provided by the normal processing of the request by the fastapi app.
 (for example, you can inject a mock of the dependency 'authenticated_partner'
 to test the behavior of your route handlers when the partner is not authenticated,
 you can also inject a mock for the odoo_env etc...)
 
-With all these features, writing a test for the 'Hello world' route handler
-defined into the demo app is as simple as
+The fastapi addon provides a base class for the test cases that you can use to
+write your tests. This base class is **'odoo.fastapi.tests.common.FastAPITransactionCase'**.
+This class mainly provides the method **'_create_test_client'** that you can
+use to create a test client for your fastapi app. This method encapsulates the
+creation of the test client and the injection of the dependencies. It also
+ensures that the odoo environment is make available into the context of the
+route handlers. This method is designed to be used when you need to test your
+app or when you need to test a specific router (It's therefore easy to defines
+tests for routers in an addon that doesn't provide a fastapi endpoint).
+
+With this base class, writing a test for a route handler is as simple as:
 
 .. code-block:: python
 
-  from functools import partial
+  from odoo.fastapi.tests.common import FastAPITransactionCase
 
-  from requests import Response
+  from odoo.addons.fastapi import dependencies
+  from odoo.addons.fastapi.routers import demo_router
 
-  from odoo.tests.common import TransactionCase
+  class FastAPIDemoCase(FastAPITransactionCase):
 
-  from fastapi.testclient import TestClient
+      @classmethod
+      def setUpClass(cls) -> None:
+          super().setUpClass()
+          cls.default_fastapi_running_user = cls.env.ref("fastapi.my_demo_app_user")
+          cls.default_fastapi_authenticated_partner = cls.env["res.partner"].create({"name": "FastAPI Demo"})
 
-  from .. import dependencies
-  from ..context import odoo_env_ctx
+      def test_hello_world(self) -> None:
+          with self._create_test_client(router=demo_router) as test_client:
+              response: Response = test_client.get("/demo/")
+          self.assertEqual(response.status_code, status.HTTP_200_OK)
+          self.assertDictEqual(response.json(), {"Hello": "World"})
 
 
-  class FastAPIDemoCase(TransactionCase):
+In the previous example, we created a test client for the demo_router. We could
+have created a test client for the whole app by not specifying the router but
+the app instead.
 
-      @classmethod
-      def setUpClass(cls) -> None:
-          super().setUpClass()
-          cls.test_partner = cls.env["res.partner"].create({"name": "FastAPI Demo"})
-          cls.fastapi_demo_app = cls.env.ref("fastapi.fastapi_endpoint_demo")
-          cls.app = cls.fastapi_demo_app._get_app()
-          cls.app.dependency_overrides[dependencies.authenticated_partner_impl] = partial(
-              lambda a: a, cls.test_partner
-          )
-          cls.client = TestClient(cls.app)
-          cls._ctx_token = odoo_env_ctx.set(cls.env)
+.. code-block:: python
 
-      @classmethod
-      def tearDownClass(cls) -> None:
-          odoo_env_ctx.reset(cls._ctx_token)
-          cls.fastapi_demo_app._reset_app()
+  from odoo.fastapi.tests.common import FastAPITransactionCase
+
+  from odoo.addons.fastapi import dependencies
+  from odoo.addons.fastapi.routers import demo_router
 
-          super().tearDownClass()
+  class FastAPIDemoCase(FastAPITransactionCase):
 
-      def _get_path(self, path) -> str:
-          return self.fastapi_demo_app.root_path + path
+      @classmethod
+      def setUpClass(cls) -> None:
+          super().setUpClass()
+          cls.default_fastapi_running_user = cls.env.ref("fastapi.my_demo_app_user")
+          cls.default_fastapi_authenticated_partner = cls.env["res.partner"].create({"name": "FastAPI Demo"})
 
       def test_hello_world(self) -> None:
-          response: Response = self.client.get(self._get_path("/"))
+          demo_endpoint = self.env.ref("fastapi.fastapi_endpoint_demo")
+          with self._create_test_client(app=demo_endpoint._get_app()) as test_client:
+              response: Response = test_client.get(f"{demo_endpoint.root_path}/demo/")
           self.assertEqual(response.status_code, status.HTTP_200_OK)
           self.assertDictEqual(response.json(), {"Hello": "World"})
 
 
 Overall considerations when you develop an fastapi app
 *******************************************************
 
@@ -1124,14 +1149,15 @@
 1. A dependency method to use to specify the pagination parameters in the same
    way for all the search route handlers: **'odoo.addons.fastapi.paging'**.
 2. A PagedCollection pydantic model to use to return the result of a search route
    handler enclosed in a json document that contains the total number of records.
 
 .. code-block:: python
 
+    from typing import Annotated
     from pydantic import BaseModel
 
     from odoo.api import Environment
     from odoo.addons.fastapi.dependencies import paging, authenticated_partner_env
     from odoo.addons.fastapi.schemas import PagedCollection, Paging
 
     class SaleOrder(BaseModel):
@@ -1141,16 +1167,16 @@
 
     @router.get(
         "/sale_orders",
         response_model=PagedCollection[SaleOrder],
         response_model_exclude_unset=True,
     )
     def get_sale_orders(
-        paging: Paging = Depends(paging),
-        env: Environment = Depends(authenticated_partner_env),
+        paging: Annotated[Paging, Depends(paging)],
+        env: Annotated[Environment, Depends(authenticated_partner_env)],
     ) -> PagedCollection[SaleOrder]:
         """Get the list of sale orders."""
         count = env["sale.order"].search_count([])
         orders = env["sale.order"].search([], limit=paging.limit, offset=paging.offset)
         return PagedCollection[SaleOrder](
             total=count,
             items=[SaleOrder.from_orm(order) for order in orders],
```

## odoo/addons/fastapi/static/description/index.html

### odoo/addons/fastapi/static/description/index.html

```diff
@@ -736,14 +736,18 @@
           <span class="n">APIRouter</span>
           <span class="p">()</span>
         </pre>
         <p>Now, you can start adding routes to your router. For example, let’s add a route
 that returns a list of partners.</p>
         <pre class="code python literal-block">
           <span class="kn">from</span>
+          <span class="nn">typing</span>
+          <span class="kn">import</span>
+          <span class="n">Annotated</span>
+          <span class="kn">from</span>
           <span class="nn">fastapi</span>
           <span class="kn">import</span>
           <span class="n">APIRouter</span>
           <span class="kn">from</span>
           <span class="nn">pydantic</span>
           <span class="kn">import</span>
           <span class="n">BaseModel</span>
@@ -752,14 +756,18 @@
           <span class="kn">import</span>
           <span class="n">api</span>
           <span class="p">,</span>
           <span class="n">fields</span>
           <span class="p">,</span>
           <span class="n">models</span>
           <span class="kn">from</span>
+          <span class="nn">odoo.api</span>
+          <span class="kn">import</span>
+          <span class="n">Environment</span>
+          <span class="kn">from</span>
           <span class="nn">odoo.addons.fastapi.dependencies</span>
           <span class="kn">import</span>
           <span class="n">odoo_env</span>
           <span class="k">class</span>
           <span class="nc">FastapiEndpoint</span>
           <span class="p">(</span>
           <span class="n">models</span>
@@ -842,19 +850,23 @@
           <span class="p">[</span>
           <span class="n">PartnerInfo</span>
           <span class="p">])</span>
           <span class="k">def</span>
           <span class="nf">get_partners</span>
           <span class="p">(</span>
           <span class="n">env</span>
-          <span class="o">=</span>
+          <span class="p">:</span>
+          <span class="n">Annotated</span>
+          <span class="p">[</span>
+          <span class="n">Environment</span>
+          <span class="p">,</span>
           <span class="n">Depends</span>
           <span class="p">(</span>
           <span class="n">odoo_env</span>
-          <span class="p">))</span>
+          <span class="p">)])</span>
           <span class="o">-&gt;</span>
           <span class="nb">list</span>
           <span class="p">[</span>
           <span class="n">PartnerInfo</span>
           <span class="p">]:</span>
           <span class="k">return</span>
           <span class="p">[</span>
@@ -996,14 +1008,22 @@
 to inject reusable dependencies into your routes. For example, the
           <strong>‘odoo_env’</strong>
           function returns the current odoo environment. You can use it to access the
 odoo models and the database from your route handlers.
         </p>
         <pre class="code python literal-block">
           <span class="kn">from</span>
+          <span class="nn">typing</span>
+          <span class="kn">import</span>
+          <span class="n">Annotated</span>
+          <span class="kn">from</span>
+          <span class="nn">odoo.api</span>
+          <span class="kn">import</span>
+          <span class="n">Environment</span>
+          <span class="kn">from</span>
           <span class="nn">odoo.addons.fastapi.dependencies</span>
           <span class="kn">import</span>
           <span class="n">odoo_env</span>
           <span class="nd">@demo_api_router</span>
           <span class="o">.</span>
           <span class="n">get</span>
           <span class="p">(</span>
@@ -1015,19 +1035,23 @@
           <span class="p">[</span>
           <span class="n">PartnerInfo</span>
           <span class="p">])</span>
           <span class="k">def</span>
           <span class="nf">get_partners</span>
           <span class="p">(</span>
           <span class="n">env</span>
-          <span class="o">=</span>
+          <span class="p">:</span>
+          <span class="n">Annotated</span>
+          <span class="p">[</span>
+          <span class="n">Environment</span>
+          <span class="p">,</span>
           <span class="n">Depends</span>
           <span class="p">(</span>
           <span class="n">odoo_env</span>
-          <span class="p">))</span>
+          <span class="p">)])</span>
           <span class="o">-&gt;</span>
           <span class="nb">list</span>
           <span class="p">[</span>
           <span class="n">PartnerInfo</span>
           <span class="p">]:</span>
           <span class="k">return</span>
           <span class="p">[</span>
@@ -1156,30 +1180,32 @@
     defined below
     &quot;&quot;&quot;</span>
           <span class="k">def</span>
           <span class="nf">fastapi_endpoint</span>
           <span class="p">(</span>
           <span class="n">_id</span>
           <span class="p">:</span>
+          <span class="n">Annotated</span>
+          <span class="p">[</span>
           <span class="nb">int</span>
-          <span class="o">=</span>
+          <span class="p">,</span>
           <span class="n">Depends</span>
           <span class="p">(</span>
           <span class="n">fastapi_endpoint_id</span>
-          <span class="p">),</span>
-          <span class="c1"># noqa: B008</span>
+          <span class="p">)],</span>
           <span class="n">env</span>
           <span class="p">:</span>
+          <span class="n">Annotated</span>
+          <span class="p">[</span>
           <span class="n">Environment</span>
-          <span class="o">=</span>
+          <span class="p">,</span>
           <span class="n">Depends</span>
           <span class="p">(</span>
           <span class="n">odoo_env</span>
-          <span class="p">),</span>
-          <span class="c1"># noqa: B008</span>
+          <span class="p">)],</span>
           <span class="p">)</span>
           <span class="o">-&gt;</span>
           <span class="s2">&quot;FastapiEndpoint&quot;</span>
           <span class="p">:</span>
           <span class="sd">&quot;&quot;&quot;Return the fastapi.endpoint record&quot;&quot;&quot;</span>
           <span class="k">return</span>
           <span class="n">env</span>
@@ -1288,14 +1314,18 @@
         </p>
         <p>
           When you define a route handler, you can inject the
           <strong>‘authenticated_partner’</strong>
           dependency as a parameter of your route handler.
         </p>
         <pre class="code python literal-block">
+          <span class="kn">from</span>
+          <span class="nn">odoo.addons.base.models.res_partner</span>
+          <span class="kn">import</span>
+          <span class="n">Partner</span>
           <span class="nd">@demo_api_router</span>
           <span class="o">.</span>
           <span class="n">get</span>
           <span class="p">(</span>
           <span class="s2">&quot;/partners&quot;</span>
           <span class="p">,</span>
           <span class="n">response_model</span>
@@ -1304,25 +1334,33 @@
           <span class="p">[</span>
           <span class="n">PartnerInfo</span>
           <span class="p">])</span>
           <span class="k">def</span>
           <span class="nf">get_partners</span>
           <span class="p">(</span>
           <span class="n">env</span>
-          <span class="o">=</span>
+          <span class="p">:</span>
+          <span class="n">Annotated</span>
+          <span class="p">[</span>
+          <span class="n">Environment</span>
+          <span class="p">,</span>
           <span class="n">Depends</span>
           <span class="p">(</span>
           <span class="n">odoo_env</span>
-          <span class="p">),</span>
+          <span class="p">)],</span>
           <span class="n">partner</span>
-          <span class="o">=</span>
+          <span class="p">:</span>
+          <span class="n">Annotated</span>
+          <span class="p">[</span>
+          <span class="n">Partner</span>
+          <span class="p">,</span>
           <span class="n">Depends</span>
           <span class="p">(</span>
           <span class="n">authenticated_partner</span>
-          <span class="p">)</span>
+          <span class="p">)]</span>
           <span class="p">)</span>
           <span class="o">-&gt;</span>
           <span class="nb">list</span>
           <span class="p">[</span>
           <span class="n">PartnerInfo</span>
           <span class="p">]:</span>
           <span class="k">return</span>
@@ -1367,28 +1405,32 @@
         </p>
         <pre class="code python literal-block">
           <span class="k">def</span>
           <span class="nf">authenticated_partner</span>
           <span class="p">(</span>
           <span class="n">env</span>
           <span class="p">:</span>
+          <span class="n">Annotated</span>
+          <span class="p">[</span>
           <span class="n">Environment</span>
-          <span class="o">=</span>
+          <span class="p">,</span>
           <span class="n">Depends</span>
           <span class="p">(</span>
           <span class="n">odoo_env</span>
-          <span class="p">),</span>
+          <span class="p">)],</span>
           <span class="n">security</span>
           <span class="p">:</span>
+          <span class="n">Annotated</span>
+          <span class="p">[</span>
           <span class="n">HTTPBasicCredentials</span>
-          <span class="o">=</span>
+          <span class="p">,</span>
           <span class="n">Depends</span>
           <span class="p">(</span>
           <span class="n">HTTPBasic</span>
-          <span class="p">()),</span>
+          <span class="p">())],</span>
           <span class="p">)</span>
           <span class="o">-&gt;</span>
           <span class="s2">&quot;res.partner&quot;</span>
           <span class="p">:</span>
           <span class="sd">&quot;&quot;&quot;Return the authenticated partner&quot;&quot;&quot;</span>
           <span class="n">partner</span>
           <span class="o">=</span>
@@ -1502,40 +1544,42 @@
           <span class="kn">import</span>
           <span class="n">APIKeyHeader</span>
           <span class="k">def</span>
           <span class="nf">api_key_based_authenticated_partner_impl</span>
           <span class="p">(</span>
           <span class="n">api_key</span>
           <span class="p">:</span>
+          <span class="n">Annotated</span>
+          <span class="p">[</span>
           <span class="nb">str</span>
-          <span class="o">=</span>
+          <span class="p">,</span>
           <span class="n">Depends</span>
           <span class="p">(</span>
-          <span class="c1"># noqa: B008</span>
           <span class="n">APIKeyHeader</span>
           <span class="p">(</span>
           <span class="n">name</span>
           <span class="o">=</span>
           <span class="s2">&quot;api-key&quot;</span>
           <span class="p">,</span>
           <span class="n">description</span>
           <span class="o">=</span>
           <span class="s2">&quot;In this demo, you can use a user's login as api key.&quot;</span>
           <span class="p">,</span>
           <span class="p">)</span>
-          <span class="p">),</span>
+          <span class="p">)],</span>
           <span class="n">env</span>
           <span class="p">:</span>
+          <span class="n">Annotated</span>
+          <span class="p">[</span>
           <span class="n">Environment</span>
-          <span class="o">=</span>
+          <span class="p">,</span>
           <span class="n">Depends</span>
           <span class="p">(</span>
           <span class="n">odoo_env</span>
-          <span class="p">),</span>
-          <span class="c1"># noqa: B008</span>
+          <span class="p">)],</span>
           <span class="p">)</span>
           <span class="o">-&gt;</span>
           <span class="n">Partner</span>
           <span class="p">:</span>
           <span class="sd">&quot;&quot;&quot;A dummy implementation that look for a user with the same login
     as the provided api key
     &quot;&quot;&quot;</span>
@@ -1872,21 +1916,22 @@
           <span class="p">)</span>
           <span class="k">async</span>
           <span class="k">def</span>
           <span class="nf">endpoint_app_info</span>
           <span class="p">(</span>
           <span class="n">endpoint</span>
           <span class="p">:</span>
+          <span class="n">Annotated</span>
+          <span class="p">[</span>
           <span class="n">FastapiEndpoint</span>
-          <span class="o">=</span>
+          <span class="p">,</span>
           <span class="n">Depends</span>
           <span class="p">(</span>
           <span class="n">fastapi_endpoint</span>
-          <span class="p">),</span>
-          <span class="c1"># noqa: B008</span>
+          <span class="p">)],</span>
           <span class="p">)</span>
           <span class="o">-&gt;</span>
           <span class="n">EndpointAppInfo</span>
           <span class="p">:</span>
           <span class="sd">&quot;&quot;&quot;Returns the current endpoint configuration&quot;&quot;&quot;</span>
           <span class="c1"># This method show you how to get access to current endpoint configuration</span>
           <span class="c1"># It also show you how you can specify a dependency to force the security</span>
@@ -2151,20 +2196,22 @@
             <span class="p">(</span>
             <span class="n">message</span>
             <span class="p">:</span>
             <span class="nb">str</span>
             <span class="p">,</span>
             <span class="n">odoo_env</span>
             <span class="p">:</span>
-            <span class="n">OdooEnv</span>
-            <span class="o">=</span>
+            <span class="n">Annotated</span>
+            <span class="p">[</span>
+            <span class="n">Environment</span>
+            <span class="p">,</span>
             <span class="n">Depends</span>
             <span class="p">(</span>
             <span class="n">odoo_env</span>
-            <span class="p">),</span>
+            <span class="p">)],</span>
             <span class="p">)</span>
             <span class="o">-&gt;</span>
             <span class="n">EchoResponse</span>
             <span class="p">:</span>
             <span class="sd">&quot;&quot;&quot;Echo the message&quot;&quot;&quot;</span>
             <span class="k">return</span>
             <span class="n">EchoResponse</span>
@@ -2318,20 +2365,22 @@
             <span class="p">(</span>
             <span class="n">message</span>
             <span class="p">:</span>
             <span class="nb">str</span>
             <span class="p">,</span>
             <span class="n">odoo_env</span>
             <span class="p">:</span>
-            <span class="n">OdooEnv</span>
-            <span class="o">=</span>
+            <span class="n">Annotated</span>
+            <span class="p">[</span>
+            <span class="n">Environment</span>
+            <span class="p">,</span>
             <span class="n">Depends</span>
             <span class="p">(</span>
             <span class="n">odoo_env</span>
-            <span class="p">),</span>
+            <span class="p">)],</span>
             <span class="p">)</span>
             <span class="o">-&gt;</span>
             <span class="n">EchoResponse</span>
             <span class="p">:</span>
             <span class="sd">&quot;&quot;&quot;Echo the message&quot;&quot;&quot;</span>
             <span class="n">echo</span>
             <span class="o">=</span>
@@ -2439,20 +2488,22 @@
             <span class="p">(</span>
             <span class="n">message</span>
             <span class="p">:</span>
             <span class="nb">str</span>
             <span class="p">,</span>
             <span class="n">odoo_env</span>
             <span class="p">:</span>
-            <span class="n">OdooEnv</span>
-            <span class="o">=</span>
+            <span class="n">Annotated</span>
+            <span class="p">[</span>
+            <span class="n">Environment</span>
+            <span class="p">,</span>
             <span class="n">Depends</span>
             <span class="p">(</span>
             <span class="n">odoo_env</span>
-            <span class="p">),</span>
+            <span class="p">)],</span>
             <span class="p">)</span>
             <span class="o">-&gt;</span>
             <span class="n">EchoResponse</span>
             <span class="p">:</span>
             <span class="sd">&quot;&quot;&quot;Echo the message&quot;&quot;&quot;</span>
             <span class="n">echo</span>
             <span class="o">=</span>
@@ -2545,20 +2596,22 @@
             <span class="p">)</span>
             <span class="k">async</span>
             <span class="k">def</span>
             <span class="nf">partner</span>
             <span class="p">(</span>
             <span class="n">partner</span>
             <span class="p">:</span>
+            <span class="n">Annotated</span>
+            <span class="p">[</span>
             <span class="n">ResPartner</span>
-            <span class="o">=</span>
+            <span class="p">,</span>
             <span class="n">Depends</span>
             <span class="p">(</span>
             <span class="n">authenticated_partner</span>
-            <span class="p">),</span>
+            <span class="p">)],</span>
             <span class="p">)</span>
             <span class="o">-&gt;</span>
             <span class="n">Partner</span>
             <span class="p">:</span>
             <span class="sd">&quot;&quot;&quot;Return the location&quot;&quot;&quot;</span>
             <span class="k">return</span>
             <span class="n">Partner</span>
@@ -2826,45 +2879,47 @@
         </p>
         <p>Once again the dependency injection mechanism comes to the rescue by allowing
 you to inject into the test client specific implementations of the dependencies
 normally provided by the normal processing of the request by the fastapi app.
 (for example, you can inject a mock of the dependency ‘authenticated_partner’
 to test the behavior of your route handlers when the partner is not authenticated,
 you can also inject a mock for the odoo_env etc…)</p>
-        <p>With all these features, writing a test for the ‘Hello world’ route handler
-defined into the demo app is as simple as</p>
+        <p>
+          The fastapi addon provides a base class for the test cases that you can use to
+write your tests. This base class is
+          <strong>‘odoo.fastapi.tests.common.FastAPITransactionCase’</strong>
+          .
+This class mainly provides the method
+          <strong>‘_create_test_client’</strong>
+          that you can
+use to create a test client for your fastapi app. This method encapsulates the
+creation of the test client and the injection of the dependencies. It also
+ensures that the odoo environment is make available into the context of the
+route handlers. This method is designed to be used when you need to test your
+app or when you need to test a specific router (It’s therefore easy to defines
+tests for routers in an addon that doesn’t provide a fastapi endpoint).
+        </p>
+        <p>With this base class, writing a test for a route handler is as simple as:</p>
         <pre class="code python literal-block">
           <span class="kn">from</span>
-          <span class="nn">functools</span>
+          <span class="nn">odoo.fastapi.tests.common</span>
           <span class="kn">import</span>
-          <span class="n">partial</span>
+          <span class="n">FastAPITransactionCase</span>
           <span class="kn">from</span>
-          <span class="nn">requests</span>
-          <span class="kn">import</span>
-          <span class="n">Response</span>
-          <span class="kn">from</span>
-          <span class="nn">odoo.tests.common</span>
-          <span class="kn">import</span>
-          <span class="n">TransactionCase</span>
-          <span class="kn">from</span>
-          <span class="nn">fastapi.testclient</span>
-          <span class="kn">import</span>
-          <span class="n">TestClient</span>
-          <span class="kn">from</span>
-          <span class="nn">..</span>
+          <span class="nn">odoo.addons.fastapi</span>
           <span class="kn">import</span>
           <span class="n">dependencies</span>
           <span class="kn">from</span>
-          <span class="nn">..context</span>
+          <span class="nn">odoo.addons.fastapi.routers</span>
           <span class="kn">import</span>
-          <span class="n">odoo_env_ctx</span>
+          <span class="n">demo_router</span>
           <span class="k">class</span>
           <span class="nc">FastAPIDemoCase</span>
           <span class="p">(</span>
-          <span class="n">TransactionCase</span>
+          <span class="n">FastAPITransactionCase</span>
           <span class="p">):</span>
           <span class="nd">@classmethod</span>
           <span class="k">def</span>
           <span class="nf">setUpClass</span>
           <span class="p">(</span>
           <span class="bp">cls</span>
           <span class="p">)</span>
@@ -2874,165 +2929,210 @@
           <span class="nb">super</span>
           <span class="p">()</span>
           <span class="o">.</span>
           <span class="n">setUpClass</span>
           <span class="p">()</span>
           <span class="bp">cls</span>
           <span class="o">.</span>
-          <span class="n">test_partner</span>
+          <span class="n">default_fastapi_running_user</span>
+          <span class="o">=</span>
+          <span class="bp">cls</span>
+          <span class="o">.</span>
+          <span class="n">env</span>
+          <span class="o">.</span>
+          <span class="n">ref</span>
+          <span class="p">(</span>
+          <span class="s2">&quot;fastapi.my_demo_app_user&quot;</span>
+          <span class="p">)</span>
+          <span class="bp">cls</span>
+          <span class="o">.</span>
+          <span class="n">default_fastapi_authenticated_partner</span>
           <span class="o">=</span>
           <span class="bp">cls</span>
           <span class="o">.</span>
           <span class="n">env</span>
           <span class="p">[</span>
           <span class="s2">&quot;res.partner&quot;</span>
           <span class="p">]</span>
           <span class="o">.</span>
           <span class="n">create</span>
           <span class="p">({</span>
           <span class="s2">&quot;name&quot;</span>
           <span class="p">:</span>
           <span class="s2">&quot;FastAPI Demo&quot;</span>
           <span class="p">})</span>
-          <span class="bp">cls</span>
-          <span class="o">.</span>
-          <span class="n">fastapi_demo_app</span>
-          <span class="o">=</span>
-          <span class="bp">cls</span>
-          <span class="o">.</span>
-          <span class="n">env</span>
-          <span class="o">.</span>
-          <span class="n">ref</span>
+          <span class="k">def</span>
+          <span class="nf">test_hello_world</span>
           <span class="p">(</span>
-          <span class="s2">&quot;fastapi.fastapi_endpoint_demo&quot;</span>
+          <span class="bp">self</span>
           <span class="p">)</span>
-          <span class="bp">cls</span>
-          <span class="o">.</span>
-          <span class="n">app</span>
-          <span class="o">=</span>
-          <span class="bp">cls</span>
-          <span class="o">.</span>
-          <span class="n">fastapi_demo_app</span>
-          <span class="o">.</span>
-          <span class="n">_get_app</span>
-          <span class="p">()</span>
-          <span class="bp">cls</span>
-          <span class="o">.</span>
-          <span class="n">app</span>
-          <span class="o">.</span>
-          <span class="n">dependency_overrides</span>
-          <span class="p">[</span>
-          <span class="n">dependencies</span>
+          <span class="o">-&gt;</span>
+          <span class="kc">None</span>
+          <span class="p">:</span>
+          <span class="k">with</span>
+          <span class="bp">self</span>
           <span class="o">.</span>
-          <span class="n">authenticated_partner_impl</span>
-          <span class="p">]</span>
-          <span class="o">=</span>
-          <span class="n">partial</span>
+          <span class="n">_create_test_client</span>
           <span class="p">(</span>
-          <span class="k">lambda</span>
-          <span class="n">a</span>
+          <span class="n">router</span>
+          <span class="o">=</span>
+          <span class="n">demo_router</span>
+          <span class="p">)</span>
+          <span class="k">as</span>
+          <span class="n">test_client</span>
           <span class="p">:</span>
-          <span class="n">a</span>
-          <span class="p">,</span>
-          <span class="bp">cls</span>
+          <span class="n">response</span>
+          <span class="p">:</span>
+          <span class="n">Response</span>
+          <span class="o">=</span>
+          <span class="n">test_client</span>
           <span class="o">.</span>
-          <span class="n">test_partner</span>
+          <span class="n">get</span>
+          <span class="p">(</span>
+          <span class="s2">&quot;/demo/&quot;</span>
           <span class="p">)</span>
-          <span class="bp">cls</span>
+          <span class="bp">self</span>
           <span class="o">.</span>
-          <span class="n">client</span>
-          <span class="o">=</span>
-          <span class="n">TestClient</span>
+          <span class="n">assertEqual</span>
           <span class="p">(</span>
-          <span class="bp">cls</span>
+          <span class="n">response</span>
           <span class="o">.</span>
-          <span class="n">app</span>
-          <span class="p">)</span>
-          <span class="bp">cls</span>
+          <span class="n">status_code</span>
+          <span class="p">,</span>
+          <span class="n">status</span>
           <span class="o">.</span>
-          <span class="n">_ctx_token</span>
-          <span class="o">=</span>
-          <span class="n">odoo_env_ctx</span>
+          <span class="n">HTTP_200_OK</span>
+          <span class="p">)</span>
+          <span class="bp">self</span>
           <span class="o">.</span>
-          <span class="n">set</span>
+          <span class="n">assertDictEqual</span>
           <span class="p">(</span>
-          <span class="bp">cls</span>
+          <span class="n">response</span>
           <span class="o">.</span>
-          <span class="n">env</span>
-          <span class="p">)</span>
+          <span class="n">json</span>
+          <span class="p">(),</span>
+          <span class="p">{</span>
+          <span class="s2">&quot;Hello&quot;</span>
+          <span class="p">:</span>
+          <span class="s2">&quot;World&quot;</span>
+          <span class="p">})</span>
+        </pre>
+        <p>In the previous example, we created a test client for the demo_router. We could
+have created a test client for the whole app by not specifying the router but
+the app instead.</p>
+        <pre class="code python literal-block">
+          <span class="kn">from</span>
+          <span class="nn">odoo.fastapi.tests.common</span>
+          <span class="kn">import</span>
+          <span class="n">FastAPITransactionCase</span>
+          <span class="kn">from</span>
+          <span class="nn">odoo.addons.fastapi</span>
+          <span class="kn">import</span>
+          <span class="n">dependencies</span>
+          <span class="kn">from</span>
+          <span class="nn">odoo.addons.fastapi.routers</span>
+          <span class="kn">import</span>
+          <span class="n">demo_router</span>
+          <span class="k">class</span>
+          <span class="nc">FastAPIDemoCase</span>
+          <span class="p">(</span>
+          <span class="n">FastAPITransactionCase</span>
+          <span class="p">):</span>
           <span class="nd">@classmethod</span>
           <span class="k">def</span>
-          <span class="nf">tearDownClass</span>
+          <span class="nf">setUpClass</span>
           <span class="p">(</span>
           <span class="bp">cls</span>
           <span class="p">)</span>
           <span class="o">-&gt;</span>
           <span class="kc">None</span>
           <span class="p">:</span>
-          <span class="n">odoo_env_ctx</span>
+          <span class="nb">super</span>
+          <span class="p">()</span>
           <span class="o">.</span>
-          <span class="n">reset</span>
-          <span class="p">(</span>
+          <span class="n">setUpClass</span>
+          <span class="p">()</span>
           <span class="bp">cls</span>
           <span class="o">.</span>
-          <span class="n">_ctx_token</span>
+          <span class="n">default_fastapi_running_user</span>
+          <span class="o">=</span>
+          <span class="bp">cls</span>
+          <span class="o">.</span>
+          <span class="n">env</span>
+          <span class="o">.</span>
+          <span class="n">ref</span>
+          <span class="p">(</span>
+          <span class="s2">&quot;fastapi.my_demo_app_user&quot;</span>
           <span class="p">)</span>
           <span class="bp">cls</span>
           <span class="o">.</span>
-          <span class="n">fastapi_demo_app</span>
+          <span class="n">default_fastapi_authenticated_partner</span>
+          <span class="o">=</span>
+          <span class="bp">cls</span>
           <span class="o">.</span>
-          <span class="n">_reset_app</span>
-          <span class="p">()</span>
-          <span class="nb">super</span>
-          <span class="p">()</span>
+          <span class="n">env</span>
+          <span class="p">[</span>
+          <span class="s2">&quot;res.partner&quot;</span>
+          <span class="p">]</span>
           <span class="o">.</span>
-          <span class="n">tearDownClass</span>
-          <span class="p">()</span>
+          <span class="n">create</span>
+          <span class="p">({</span>
+          <span class="s2">&quot;name&quot;</span>
+          <span class="p">:</span>
+          <span class="s2">&quot;FastAPI Demo&quot;</span>
+          <span class="p">})</span>
           <span class="k">def</span>
-          <span class="nf">_get_path</span>
+          <span class="nf">test_hello_world</span>
           <span class="p">(</span>
           <span class="bp">self</span>
-          <span class="p">,</span>
-          <span class="n">path</span>
           <span class="p">)</span>
           <span class="o">-&gt;</span>
-          <span class="nb">str</span>
+          <span class="kc">None</span>
           <span class="p">:</span>
-          <span class="k">return</span>
+          <span class="n">demo_endpoint</span>
+          <span class="o">=</span>
           <span class="bp">self</span>
           <span class="o">.</span>
-          <span class="n">fastapi_demo_app</span>
+          <span class="n">env</span>
           <span class="o">.</span>
-          <span class="n">root_path</span>
-          <span class="o">+</span>
-          <span class="n">path</span>
-          <span class="k">def</span>
-          <span class="nf">test_hello_world</span>
+          <span class="n">ref</span>
           <span class="p">(</span>
-          <span class="bp">self</span>
+          <span class="s2">&quot;fastapi.fastapi_endpoint_demo&quot;</span>
           <span class="p">)</span>
-          <span class="o">-&gt;</span>
-          <span class="kc">None</span>
+          <span class="k">with</span>
+          <span class="bp">self</span>
+          <span class="o">.</span>
+          <span class="n">_create_test_client</span>
+          <span class="p">(</span>
+          <span class="n">app</span>
+          <span class="o">=</span>
+          <span class="n">demo_endpoint</span>
+          <span class="o">.</span>
+          <span class="n">_get_app</span>
+          <span class="p">())</span>
+          <span class="k">as</span>
+          <span class="n">test_client</span>
           <span class="p">:</span>
           <span class="n">response</span>
           <span class="p">:</span>
           <span class="n">Response</span>
           <span class="o">=</span>
-          <span class="bp">self</span>
-          <span class="o">.</span>
-          <span class="n">client</span>
+          <span class="n">test_client</span>
           <span class="o">.</span>
           <span class="n">get</span>
           <span class="p">(</span>
-          <span class="bp">self</span>
+          <span class="sa">f</span>
+          <span class="s2">&quot;</span>
+          <span class="si">{</span>
+          <span class="n">demo_endpoint</span>
           <span class="o">.</span>
-          <span class="n">_get_path</span>
-          <span class="p">(</span>
-          <span class="s2">&quot;/&quot;</span>
-          <span class="p">))</span>
+          <span class="n">root_path</span>
+          <span class="si">}</span>
+          <span class="s2">/demo/&quot;</span>
+          <span class="p">)</span>
           <span class="bp">self</span>
           <span class="o">.</span>
           <span class="n">assertEqual</span>
           <span class="p">(</span>
           <span class="n">response</span>
           <span class="o">.</span>
           <span class="n">status_code</span>
@@ -3210,14 +3310,18 @@
               .
             </li>
             <li>A PagedCollection pydantic model to use to return the result of a search route
 handler enclosed in a json document that contains the total number of records.</li>
           </ol>
           <pre class="code python literal-block">
             <span class="kn">from</span>
+            <span class="nn">typing</span>
+            <span class="kn">import</span>
+            <span class="n">Annotated</span>
+            <span class="kn">from</span>
             <span class="nn">pydantic</span>
             <span class="kn">import</span>
             <span class="n">BaseModel</span>
             <span class="kn">from</span>
             <span class="nn">odoo.api</span>
             <span class="kn">import</span>
             <span class="n">Environment</span>
@@ -3262,28 +3366,32 @@
             <span class="p">,</span>
             <span class="p">)</span>
             <span class="k">def</span>
             <span class="nf">get_sale_orders</span>
             <span class="p">(</span>
             <span class="n">paging</span>
             <span class="p">:</span>
+            <span class="n">Annotated</span>
+            <span class="p">[</span>
             <span class="n">Paging</span>
-            <span class="o">=</span>
+            <span class="p">,</span>
             <span class="n">Depends</span>
             <span class="p">(</span>
             <span class="n">paging</span>
-            <span class="p">),</span>
+            <span class="p">)],</span>
             <span class="n">env</span>
             <span class="p">:</span>
+            <span class="n">Annotated</span>
+            <span class="p">[</span>
             <span class="n">Environment</span>
-            <span class="o">=</span>
+            <span class="p">,</span>
             <span class="n">Depends</span>
             <span class="p">(</span>
             <span class="n">authenticated_partner_env</span>
-            <span class="p">),</span>
+            <span class="p">)],</span>
             <span class="p">)</span>
             <span class="o">-&gt;</span>
             <span class="n">PagedCollection</span>
             <span class="p">[</span>
             <span class="n">SaleOrder</span>
             <span class="p">]:</span>
             <span class="sd">&quot;&quot;&quot;Get the list of sale orders.&quot;&quot;&quot;</span>
```

## odoo/addons/fastapi/tests/test_fastapi.py

```diff
@@ -18,21 +18,21 @@
             cls.env["res.lang"]
             .with_context(active_test=False)
             .search([("code", "=", "fr_BE")])
         )
         lang.active = True
 
     def _assert_expected_lang(self, accept_language, expected_lang):
-        route = "/fastapi_demo/lang"
+        route = "/fastapi_demo/demo/lang"
         response = self.url_open(route, headers={"Accept-language": accept_language})
         self.assertEqual(response.status_code, 200)
         self.assertEqual(response.content, expected_lang)
 
     def test_call(self):
-        route = "/fastapi_demo/"
+        route = "/fastapi_demo/demo/"
         response = self.url_open(route)
         self.assertEqual(response.status_code, 200)
         self.assertEqual(response.content, b'{"Hello":"World"}')
 
     def test_lang(self):
         self._assert_expected_lang("fr,en;q=0.7,en-GB;q=0.3", b'"fr_BE"')
         self._assert_expected_lang("en,fr;q=0.7,en-GB;q=0.3", b'"en_US"')
```

## odoo/addons/fastapi/tests/test_fastapi_demo.py

```diff
@@ -1,71 +1,59 @@
 # Copyright 2022 ACSONE SA/NV
 # License LGPL-3.0 or later (http://www.gnu.org/licenses/LGPL).
 
 from functools import partial
 from unittest import mock
 
-import odoo
-from odoo.tests.common import TransactionCase
+from requests import Response
+
 from odoo.tools import mute_logger
 
 from fastapi import status
-from fastapi.testclient import TestClient
 
-from .. import dependencies
-from ..context import odoo_env_ctx
-from ..models.fastapi_endpoint_demo import EndpointAppInfo, ExceptionType
+from ..dependencies import fastapi_endpoint
+from ..routers import demo_router
+from ..schemas import DemoEndpointAppInfo, DemoExceptionType
+from .common import FastAPITransactionCase
 
 
-@odoo.tests.tagged("post_install", "-at_install")
-class FastAPIDemoCase(TransactionCase):
+class FastAPIDemoCase(FastAPITransactionCase):
     """The fastapi lib comes with a useful testclient that let's you
     easily test your endpoints. Moreover, the dependency overrides functionality
     allows you to provide specific implementation for part of the code to avoid
     to rely on some tricky http stuff for example: authentication
 
     This test class is an example on how you can test your own code
     """
 
     @classmethod
     def setUpClass(cls) -> None:
         super().setUpClass()
-        cls.test_partner = cls.env["res.partner"].create({"name": "FastAPI Demo"})
-        cls.fastapi_demo_app = cls.env.ref("fastapi.fastapi_endpoint_demo")
-        cls.app = cls.fastapi_demo_app._get_app()
-        cls.app.dependency_overrides[dependencies.authenticated_partner_impl] = partial(
-            lambda a: a, cls.test_partner
-        )
-        # we need to disable the raise of unexpected exception into the called
-        # service to test the error handling of the endpoint. By default, the
-        # TestClient will let unexpected exception bubble up to the test method
-        # to allows you to process the error accordingly
-        cls.client = TestClient(cls.app, raise_server_exceptions=False)
-        cls._ctx_token = odoo_env_ctx.set(
-            cls.env(user=cls.env.ref("fastapi.my_demo_app_user"))
+        cls.default_fastapi_router = demo_router
+        cls.default_fastapi_running_user = cls.env.ref("fastapi.my_demo_app_user")
+        cls.default_fastapi_authenticated_partner = cls.env["res.partner"].create(
+            {"name": "FastAPI Demo"}
         )
 
-    @classmethod
-    def tearDownClass(cls) -> None:
-        odoo_env_ctx.reset(cls._ctx_token)
-        cls.fastapi_demo_app._reset_app()
-
-        super().tearDownClass()
-
     @mute_logger("odoo.addons.fastapi.error_handlers")
     def assert_exception_processed(
         self,
-        exception_type: ExceptionType,
+        exception_type: DemoExceptionType,
         error_message: str,
         expected_message: str,
         expected_status_code: int,
     ) -> None:
-        with mock.patch.object(self.env.cr.__class__, "rollback") as mock_rollback:
-            response = self.client.get(
-                "/exception",
+        demo_app = self.env.ref("fastapi.fastapi_endpoint_demo")
+        with self._create_test_client(
+            demo_app._get_app(), raise_server_exceptions=False
+        ) as test_client, mock.patch.object(
+            self.env.cr.__class__, "rollback"
+        ) as mock_rollback:
+            response: Response = test_client.get(
+                "/demo/exception",
                 params={
                     "exception_type": exception_type.value,
                     "error_message": error_message,
                 },
             )
             mock_rollback.assert_called_once()
         self.assertEqual(response.status_code, expected_status_code)
@@ -73,77 +61,84 @@
             response.json(),
             {
                 "detail": expected_message,
             },
         )
 
     def test_hello_world(self) -> None:
-        response = self.client.get("/")
+        with self._create_test_client() as test_client:
+            response: Response = test_client.get("/demo/")
         self.assertEqual(response.status_code, status.HTTP_200_OK)
         self.assertDictEqual(response.json(), {"Hello": "World"})
 
     def test_who_ami(self) -> None:
-        response = self.client.get("/who_ami")
+        with self._create_test_client() as test_client:
+            response: Response = test_client.get("/demo/who_ami")
         self.assertEqual(response.status_code, status.HTTP_200_OK)
+        partner = self.default_fastapi_authenticated_partner
         self.assertDictEqual(
             response.json(),
             {
-                "name": self.test_partner.name,
-                "display_name": self.test_partner.display_name,
+                "name": partner.name,
+                "display_name": partner.display_name,
             },
         )
 
     def test_endpoint_info(self) -> None:
-        response = self.client.get("/endpoint_app_info")
+        demo_app = self.env.ref("fastapi.fastapi_endpoint_demo")
+        with self._create_test_client(
+            dependency_overrides={fastapi_endpoint: partial(lambda a: a, demo_app)}
+        ) as test_client:
+            response: Response = test_client.get("/demo/endpoint_app_info")
         self.assertEqual(response.status_code, status.HTTP_200_OK)
         self.assertDictEqual(
             response.json(),
-            EndpointAppInfo.from_orm(self.fastapi_demo_app).dict(by_alias=True),
+            DemoEndpointAppInfo.from_orm(demo_app).dict(by_alias=True),
         )
 
     def test_user_error(self) -> None:
         self.assert_exception_processed(
-            exception_type=ExceptionType.user_error,
+            exception_type=DemoExceptionType.user_error,
             error_message="test",
             expected_message="test",
             expected_status_code=status.HTTP_400_BAD_REQUEST,
         )
 
     def test_validation_error(self) -> None:
         self.assert_exception_processed(
-            exception_type=ExceptionType.validation_error,
+            exception_type=DemoExceptionType.validation_error,
             error_message="test",
             expected_message="test",
             expected_status_code=status.HTTP_400_BAD_REQUEST,
         )
 
     def test_bare_exception(self) -> None:
         self.assert_exception_processed(
-            exception_type=ExceptionType.bare_exception,
+            exception_type=DemoExceptionType.bare_exception,
             error_message="test",
             expected_message="test",
             expected_status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
         )
 
     def test_access_error(self) -> None:
         self.assert_exception_processed(
-            exception_type=ExceptionType.access_error,
+            exception_type=DemoExceptionType.access_error,
             error_message="test",
             expected_message="AccessError",
             expected_status_code=status.HTTP_403_FORBIDDEN,
         )
 
     def test_missing_error(self) -> None:
         self.assert_exception_processed(
-            exception_type=ExceptionType.missing_error,
+            exception_type=DemoExceptionType.missing_error,
             error_message="test",
             expected_message="MissingError",
             expected_status_code=status.HTTP_404_NOT_FOUND,
         )
 
     def test_http_exception(self) -> None:
         self.assert_exception_processed(
-            exception_type=ExceptionType.http_exception,
+            exception_type=DemoExceptionType.http_exception,
             error_message="test",
             expected_message="test",
             expected_status_code=status.HTTP_409_CONFLICT,
         )
```

## Comparing `odoo_addon_fastapi-16.0.0.0.3.dist-info/METADATA` & `odoo_addon_fastapi-16.0.0.0.4.dist-info/METADATA`

 * *Files 6% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: odoo-addon-fastapi
-Version: 16.0.0.0.3
+Version: 16.0.0.0.4
 Summary: Odoo FastAPI endpoint
 Home-page: https://github.com/OCA/rest-framework
 Author: ACSONE SA/NV,Odoo Community Association (OCA)
 Author-email: support@odoo-community.org
 License: LGPL-3
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
@@ -223,17 +223,22 @@
     demo_api_router = APIRouter()
 
 Now, you can start adding routes to your router. For example, let's add a route
 that returns a list of partners.
 
 .. code-block:: python
 
+    from typing import Annotated
+
     from fastapi import APIRouter
     from pydantic import BaseModel
+
     from odoo import api, fields, models
+    from odoo.api import Environment
+
     from odoo.addons.fastapi.dependencies import odoo_env
 
     class FastapiEndpoint(models.Model):
 
         _inherit = "fastapi.endpoint"
 
         app: str = fields.Selection(
@@ -249,15 +254,15 @@
     demo_api_router = APIRouter()
 
     class PartnerInfo(BaseModel):
         name: str
         email: str
 
     @demo_api_router.get("/partners", response_model=list[PartnerInfo])
-    def get_partners(env=Depends(odoo_env)) -> list[PartnerInfo]:
+    def get_partners(env: Annotated[Environment, Depends(odoo_env)]) -> list[PartnerInfo]:
         return [
             PartnerInfo(name=partner.name, email=partner.email)
             for partner in env["res.partner"].search([])
         ]
 
 Now, you can start your Odoo server, install your addon and create a new endpoint
 instance for your app. Once it's done click on the docs url to access the
@@ -321,18 +326,21 @@
 The **'odoo.addons.fastapi.dependencies'** module provides a set of functions that you can use
 to inject reusable dependencies into your routes. For example, the **'odoo_env'**
 function returns the current odoo environment. You can use it to access the
 odoo models and the database from your route handlers.
 
 .. code-block:: python
 
+    from typing import Annotated
+
+    from odoo.api import Environment
     from odoo.addons.fastapi.dependencies import odoo_env
 
     @demo_api_router.get("/partners", response_model=list[PartnerInfo])
-    def get_partners(env=Depends(odoo_env)) -> list[PartnerInfo]:
+    def get_partners(env: Annotated[Environment, Depends(odoo_env)]) -> list[PartnerInfo]:
         return [
             PartnerInfo(name=partner.name, email=partner.email)
             for partner in env["res.partner"].search([])
         ]
 
 As you can see, you can use the **'Depends'** function to inject the dependency
 into your route handler. The **'Depends'** function is provided by the
@@ -384,16 +392,16 @@
         available for your endpoint method. To get the fastapi.endpoint record
         in your method, you just need to add a dependency on the fastapi_endpoint method
         defined below
         """
 
 
     def fastapi_endpoint(
-        _id: int = Depends(fastapi_endpoint_id),  # noqa: B008
-        env: Environment = Depends(odoo_env),  # noqa: B008
+        _id: Annotated[int, Depends(fastapi_endpoint_id)],
+        env: Annotated[Environment, Depends(odoo_env)],
     ) -> "FastapiEndpoint":
         """Return the fastapi.endpoint record"""
         return env["fastapi.endpoint"].browse(_id)
 
 
 As you can see, one of these dependencies is the **'fastapi_endpoint_id'**
 dependency and has no concrete implementation. This method is used as a contract
@@ -428,17 +436,20 @@
 **'fastapi_endpoint'** this dependency depends on an abstract dependency.
 
 When you define a route handler, you can inject the **'authenticated_partner'**
 dependency as a parameter of your route handler.
 
 .. code-block:: python
 
+    from odoo.addons.base.models.res_partner import Partner
+
+
     @demo_api_router.get("/partners", response_model=list[PartnerInfo])
     def get_partners(
-        env=Depends(odoo_env), partner=Depends(authenticated_partner)
+        env: Annotated[Environment, Depends(odoo_env)], partner: Annotated[Partner, Depends(authenticated_partner)]
     ) -> list[PartnerInfo]:
         return [
             PartnerInfo(name=partner.name, email=partner.email)
             for partner in env["res.partner"].search([])
         ]
 
 
@@ -449,16 +460,16 @@
 'BasicAuth' method. This authentication mechanism is implemented in the
 **'odoo.addons.fastapi.dependencies'** module and relies on functionalities provided
 by the **'fastapi.security'** module.
 
 .. code-block:: python
 
       def authenticated_partner(
-          env: Environment = Depends(odoo_env),
-          security: HTTPBasicCredentials = Depends(HTTPBasic()),
+          env: Annotated[Environment, Depends(odoo_env)],
+          security: Annotated[HTTPBasicCredentials, Depends(HTTPBasic())],
       ) -> "res.partner":
           """Return the authenticated partner"""
           partner = env["res.partner"].search(
               [("email", "=", security.username)], limit=1
           )
           if not partner:
               raise HTTPException(
@@ -493,21 +504,21 @@
 implemented, we will only implement the api key authentication mechanism.
 
 .. code-block:: python
 
   from fastapi.security import APIKeyHeader
 
   def api_key_based_authenticated_partner_impl(
-      api_key: str = Depends(  # noqa: B008
+      api_key: Annotated[str, Depends(
           APIKeyHeader(
               name="api-key",
               description="In this demo, you can use a user's login as api key.",
           )
-      ),
-      env: Environment = Depends(odoo_env),  # noqa: B008
+      )],
+      env: Annotated[Environment, Depends(odoo_env)],
   ) -> Partner:
       """A dummy implementation that look for a user with the same login
       as the provided api key
       """
       partner = env["res.users"].search([("login", "=", api_key)], limit=1).partner_id
       if not partner:
           raise HTTPException(
@@ -621,15 +632,15 @@
 
     @demo_api_router.get(
         "/endpoint_app_info",
         response_model=EndpointAppInfo,
         dependencies=[Depends(authenticated_partner)],
     )
     async def endpoint_app_info(
-        endpoint: FastapiEndpoint = Depends(fastapi_endpoint),  # noqa: B008
+        endpoint: Annotated[FastapiEndpoint, Depends(fastapi_endpoint)],
     ) -> EndpointAppInfo:
         """Returns the current endpoint configuration"""
         # This method show you how to get access to current endpoint configuration
         # It also show you how you can specify a dependency to force the security
         # even if the method doesn't require the authenticated partner as parameter
         return EndpointAppInfo.from_orm(endpoint)
 
@@ -747,15 +758,15 @@
   @demo_api_router.get(
       "/echo",
       response_model=EchoResponse,
       dependencies=[Depends(odoo_env)],
   )
   async def echo(
       message: str,
-      odoo_env: OdooEnv = Depends(odoo_env),
+      odoo_env: Annotated[Environment, Depends(odoo_env)],
   ) -> EchoResponse:
       """Echo the message"""
       return EchoResponse(message=odoo_env["demo.fastapi.endpoint"].echo(message))
 
   class EchoResponse(BaseModel):
       message: str
 
@@ -812,15 +823,15 @@
   @demo_api_router.get(
       "/echo2",
       response_model=EchoResponse,
       dependencies=[Depends(odoo_env)],
   )
   async def echo2(
       message: str,
-      odoo_env: OdooEnv = Depends(odoo_env),
+      odoo_env: Annotated[Environment, Depends(odoo_env)],
   ) -> EchoResponse:
       """Echo the message"""
       echo = odoo_env["demo.fastapi.endpoint"].echo2(message)
       return EchoResponse(message=f"Echo2: {echo}")
 
 The problem with this approach is that you unconditionally add the new route
 handler to the existing app even if the app is called for a different database
@@ -847,15 +858,15 @@
   @additional_demo_api_router.get(
       "/echo2",
       response_model=EchoResponse,
       dependencies=[Depends(odoo_env)],
   )
   async def echo2(
       message: str,
-      odoo_env: OdooEnv = Depends(odoo_env),
+      odoo_env: Annotated[Environment, Depends(odoo_env)],
   ) -> EchoResponse:
       """Echo the message"""
       echo = odoo_env["demo.fastapi.endpoint"].echo2(message)
       return EchoResponse(message=f"Echo2: {echo}")
 
 
 In this way, the new router is added to the list of routers of your app only if
@@ -894,15 +905,15 @@
 
   @demo_api_router.get(
       "/partner",
       response_model=Location,
       dependencies=[Depends(authenticated_partner)],
   )
   async def partner(
-      partner: ResPartner = Depends(authenticated_partner),
+      partner: Annotated[ResPartner, Depends(authenticated_partner)],
   ) -> Partner:
       """Return the location"""
       return Partner.from_orm(partner)
 
 
 If you need to add a new field into the model **'Partner'**, you can extend it
 in your new addon by defining a new model that inherits from the model **'Partner'**.
@@ -1025,57 +1036,71 @@
 Once again the dependency injection mechanism comes to the rescue by allowing
 you to inject into the test client specific implementations of the dependencies
 normally provided by the normal processing of the request by the fastapi app.
 (for example, you can inject a mock of the dependency 'authenticated_partner'
 to test the behavior of your route handlers when the partner is not authenticated,
 you can also inject a mock for the odoo_env etc...)
 
-With all these features, writing a test for the 'Hello world' route handler
-defined into the demo app is as simple as
+The fastapi addon provides a base class for the test cases that you can use to
+write your tests. This base class is **'odoo.fastapi.tests.common.FastAPITransactionCase'**.
+This class mainly provides the method **'_create_test_client'** that you can
+use to create a test client for your fastapi app. This method encapsulates the
+creation of the test client and the injection of the dependencies. It also
+ensures that the odoo environment is make available into the context of the
+route handlers. This method is designed to be used when you need to test your
+app or when you need to test a specific router (It's therefore easy to defines
+tests for routers in an addon that doesn't provide a fastapi endpoint).
+
+With this base class, writing a test for a route handler is as simple as:
 
 .. code-block:: python
 
-  from functools import partial
+  from odoo.fastapi.tests.common import FastAPITransactionCase
 
-  from requests import Response
+  from odoo.addons.fastapi import dependencies
+  from odoo.addons.fastapi.routers import demo_router
 
-  from odoo.tests.common import TransactionCase
+  class FastAPIDemoCase(FastAPITransactionCase):
 
-  from fastapi.testclient import TestClient
+      @classmethod
+      def setUpClass(cls) -> None:
+          super().setUpClass()
+          cls.default_fastapi_running_user = cls.env.ref("fastapi.my_demo_app_user")
+          cls.default_fastapi_authenticated_partner = cls.env["res.partner"].create({"name": "FastAPI Demo"})
 
-  from .. import dependencies
-  from ..context import odoo_env_ctx
+      def test_hello_world(self) -> None:
+          with self._create_test_client(router=demo_router) as test_client:
+              response: Response = test_client.get("/demo/")
+          self.assertEqual(response.status_code, status.HTTP_200_OK)
+          self.assertDictEqual(response.json(), {"Hello": "World"})
 
 
-  class FastAPIDemoCase(TransactionCase):
+In the previous example, we created a test client for the demo_router. We could
+have created a test client for the whole app by not specifying the router but
+the app instead.
 
-      @classmethod
-      def setUpClass(cls) -> None:
-          super().setUpClass()
-          cls.test_partner = cls.env["res.partner"].create({"name": "FastAPI Demo"})
-          cls.fastapi_demo_app = cls.env.ref("fastapi.fastapi_endpoint_demo")
-          cls.app = cls.fastapi_demo_app._get_app()
-          cls.app.dependency_overrides[dependencies.authenticated_partner_impl] = partial(
-              lambda a: a, cls.test_partner
-          )
-          cls.client = TestClient(cls.app)
-          cls._ctx_token = odoo_env_ctx.set(cls.env)
+.. code-block:: python
 
-      @classmethod
-      def tearDownClass(cls) -> None:
-          odoo_env_ctx.reset(cls._ctx_token)
-          cls.fastapi_demo_app._reset_app()
+  from odoo.fastapi.tests.common import FastAPITransactionCase
+
+  from odoo.addons.fastapi import dependencies
+  from odoo.addons.fastapi.routers import demo_router
 
-          super().tearDownClass()
+  class FastAPIDemoCase(FastAPITransactionCase):
 
-      def _get_path(self, path) -> str:
-          return self.fastapi_demo_app.root_path + path
+      @classmethod
+      def setUpClass(cls) -> None:
+          super().setUpClass()
+          cls.default_fastapi_running_user = cls.env.ref("fastapi.my_demo_app_user")
+          cls.default_fastapi_authenticated_partner = cls.env["res.partner"].create({"name": "FastAPI Demo"})
 
       def test_hello_world(self) -> None:
-          response: Response = self.client.get(self._get_path("/"))
+          demo_endpoint = self.env.ref("fastapi.fastapi_endpoint_demo")
+          with self._create_test_client(app=demo_endpoint._get_app()) as test_client:
+              response: Response = test_client.get(f"{demo_endpoint.root_path}/demo/")
           self.assertEqual(response.status_code, status.HTTP_200_OK)
           self.assertDictEqual(response.json(), {"Hello": "World"})
 
 
 Overall considerations when you develop an fastapi app
 *******************************************************
 
@@ -1222,14 +1247,15 @@
 1. A dependency method to use to specify the pagination parameters in the same
    way for all the search route handlers: **'odoo.addons.fastapi.paging'**.
 2. A PagedCollection pydantic model to use to return the result of a search route
    handler enclosed in a json document that contains the total number of records.
 
 .. code-block:: python
 
+    from typing import Annotated
     from pydantic import BaseModel
 
     from odoo.api import Environment
     from odoo.addons.fastapi.dependencies import paging, authenticated_partner_env
     from odoo.addons.fastapi.schemas import PagedCollection, Paging
 
     class SaleOrder(BaseModel):
@@ -1239,16 +1265,16 @@
 
     @router.get(
         "/sale_orders",
         response_model=PagedCollection[SaleOrder],
         response_model_exclude_unset=True,
     )
     def get_sale_orders(
-        paging: Paging = Depends(paging),
-        env: Environment = Depends(authenticated_partner_env),
+        paging: Annotated[Paging, Depends(paging)],
+        env: Annotated[Environment, Depends(authenticated_partner_env)],
     ) -> PagedCollection[SaleOrder]:
         """Get the list of sale orders."""
         count = env["sale.order"].search_count([])
         orders = env["sale.order"].search([], limit=paging.limit, offset=paging.offset)
         return PagedCollection[SaleOrder](
             total=count,
             items=[SaleOrder.from_orm(order) for order in orders],
```

## Comparing `odoo_addon_fastapi-16.0.0.0.3.dist-info/RECORD` & `odoo_addon_fastapi-16.0.0.0.4.dist-info/RECORD`

 * *Files 14% similar despite different names*

```diff
@@ -1,36 +1,39 @@
-odoo/addons/fastapi/README.rst,sha256=BWtBKxzhXCzXvrU-S_2RPMeTWzfhfmrQEi2emk3wvm0,62389
+odoo/addons/fastapi/README.rst,sha256=EDX9V_y5RvkOVGt0Alif7RG3YPyKPou0XmZbj5xwegk,64055
 odoo/addons/fastapi/__init__.py,sha256=A9H791sAzcrI702uasMbvjLSMGOzdFvCADu_qnHL0ww,54
-odoo/addons/fastapi/__manifest__.py,sha256=VC7qgT_OwL-f7CybYqXS6mNCJR79rNFO8keBw5Z4guI,961
+odoo/addons/fastapi/__manifest__.py,sha256=AIa9zOnzcIgvSSYtRf3kGYETdzeVk3W-AqnJxmC1Cdc,961
 odoo/addons/fastapi/context.py,sha256=R89-ncfIYWCVa4Y0M1R3pnKK-sADSY4chMKVTT5J2Uk,276
-odoo/addons/fastapi/dependencies.py,sha256=jCGw0yUlKaLZkaHS2KLCxfaw8H5SUFHCmShI7i-DIw4,4505
+odoo/addons/fastapi/dependencies.py,sha256=-wpfTxOaMg_b38Ic42ODDr6YKonURHsLXV-sqi71Fk8,4527
 odoo/addons/fastapi/depends.py,sha256=DqaPH3Sm1Cc-5WwitXwW5TP5jij__iN6WtWUuLllx-w,305
 odoo/addons/fastapi/error_handlers.py,sha256=meh1OkW8AxxZ4QvLeig4n9JGbTK-aPAIBp3Zi625LwI,2272
 odoo/addons/fastapi/fastapi_dispatcher.py,sha256=pFzju0m5G092Th4bPKGVRTgIiL_BDA_fv5MLCa-Lpyo,2484
-odoo/addons/fastapi/schemas.py,sha256=tmgBpPaRHFNERqHHqjyNm-3bl1ME1SXHpaMSwfz0MO4,404
+odoo/addons/fastapi/schemas.py,sha256=9tQUZ6kh8utKNOIWGEx-YlTrrlFSTgj1Lf1nOmOuDPI,1134
 odoo/addons/fastapi/demo/fastapi_endpoint_demo.xml,sha256=OYw6_lrEXEgH3jYdjUC1TknyLAfJ8TN8BoqsLn_q5UA,1867
 odoo/addons/fastapi/i18n/fastapi.pot,sha256=iUe_pGA2zKZg3JkX51Sb4mwU5Y6Dh1WA0DghBU8-UfA,6371
-odoo/addons/fastapi/models/__init__.py,sha256=oyzZ18ZEmOqi5-VIodgbHZ9bekIMeJqaW7LUD-HZXQE,112
+odoo/addons/fastapi/models/__init__.py,sha256=-bL9X3GTzJukpNzwxsQHGC0PVM4t0W3wIkLr7btmrqc,127
 odoo/addons/fastapi/models/fastapi_endpoint.py,sha256=s-a5_bAIq68ilXwdbv3fWmjZoMK056CH2hqXbVDvlQw,9779
-odoo/addons/fastapi/models/fastapi_endpoint_demo.py,sha256=WeQSuMR5Cj00210klXL00iGTzGTPNCJXkNFEW9ANd2c,6182
+odoo/addons/fastapi/models/fastapi_endpoint_demo.py,sha256=Sm6ztf6P6t9txrNYUFl_iqHELG98KOI_27jXzpP9pvY,3515
 odoo/addons/fastapi/models/ir_rule.py,sha256=bV_2Ses0KKTRmbqVkBBjSBG_ADLALzjmKGNGWoXevCk,978
 odoo/addons/fastapi/models/res_lang.py,sha256=H0J_5lth6LS6nU0ZyYuNA4-hAJFXaturu4DGOL_4KBk,1712
 odoo/addons/fastapi/readme/CONTRIBUTORS.rst,sha256=RqZZFJ_WyebKrBztRG56MCIHBnSryLzhaxlXepsfhVg,44
 odoo/addons/fastapi/readme/DESCRIPTION.rst,sha256=r_eA-Tm3-rn-N6HrAcFLw8pEDKMrP6Bxp48lLIIh6vI,2255
 odoo/addons/fastapi/readme/ROADMAP.rst,sha256=P0CcajuBLd0FYckLk210IeFhFGwf13xk-qnqGRK2nQg,709
-odoo/addons/fastapi/readme/USAGE.rst,sha256=T2OZOABVKFv5kG5zbUHzPdQiqxopz_XXGEV1EnC9qFI,56584
+odoo/addons/fastapi/readme/USAGE.rst,sha256=MZqM4oI9d2SWRAFQj8OWi7U8nIegddi25L9uSwjSsQI,58250
+odoo/addons/fastapi/routers/__init__.py,sha256=yfncpQheVDWse00UaiVtZYgpj1nHxuAKdAvzO_RfMY8,99
+odoo/addons/fastapi/routers/demo_router.py,sha256=Bg1ggqa9eNejpyJHetfOuMqlaBODqxBkoWWEUwYwVv8,3067
 odoo/addons/fastapi/security/fastapi_endpoint.xml,sha256=FBvObSIGOJCRkdsBdeD3FHb_2eDFj1xZRvVNiA6-8zo,1058
 odoo/addons/fastapi/security/ir_rule+acl.xml,sha256=YyVEXm2x5LZs85HR18af1m6K6zGBy_IqX45pyJhXXMU,3338
 odoo/addons/fastapi/security/res_groups.xml,sha256=F4n20EtRZFECjMAyPQuXSjFr4Lp3SW9Dddm4gjZKF5g,1418
 odoo/addons/fastapi/static/description/endpoint_create.png,sha256=-jJmDu51GbbpNdr8RJQlBMnTiDmUMEfoIk6ALHdfdAM,33245
 odoo/addons/fastapi/static/description/icon.png,sha256=vR-wxFP4tYM2kirXIDMwPaOmHPFEMnqfY78uhGhn4Yo,36542
-odoo/addons/fastapi/static/description/index.html,sha256=SU3WttiVWyrxFIUQj7Jv1OqJGtbypt96xHK-Issyy-w,129974
+odoo/addons/fastapi/static/description/index.html,sha256=ev_rZipJF4vqbFcZ62CFENY_mRzlTHTe981iG9-ef78,133832
 odoo/addons/fastapi/tests/__init__.py,sha256=cJ0WZNnDuNOWtiGyjY6EsIg1g1dLc4EwUzdUqfUbsdQ,59
-odoo/addons/fastapi/tests/test_fastapi.py,sha256=AZu5Mwg7p8Nt-NAdbYpfmeixs8gSx1u7uKNdwYVPelI,1500
-odoo/addons/fastapi/tests/test_fastapi_demo.py,sha256=nJIZob35znD9axLfOYMJBYILpza72fYAUhqEx3twWvU,5451
+odoo/addons/fastapi/tests/common.py,sha256=nWYvJEU-Xa4d-01w5K9Og9qC_yZGbR1iYK7qH2_qjXo,4774
+odoo/addons/fastapi/tests/test_fastapi.py,sha256=B_uGxMl0YSO_IIH7EjPc3g9ZdtmEFuZJv0mteufJ9J0,1510
+odoo/addons/fastapi/tests/test_fastapi_demo.py,sha256=y_y6Tl51BXGueLqGBR0YcDKSahuU_aGMdetVDGg5kPk,5299
 odoo/addons/fastapi/views/fastapi_endpoint.xml,sha256=Qx1-aHoAEFzcbuX_W8sjeaXvVhH9QQWdhk9rZUuPK_Y,5471
 odoo/addons/fastapi/views/fastapi_endpoint_demo.xml,sha256=gyweL51A1L4qHYyBKxBAg0WtlccnSEXZBQQj42BQbEk,873
 odoo/addons/fastapi/views/fastapi_menu.xml,sha256=jQP5SrQaiqPvSM-d7NYF280nbMPlMCZ9Jj4GkssIc9A,466
-odoo_addon_fastapi-16.0.0.0.3.dist-info/METADATA,sha256=H5fGjn_enubKdJ23YLvhxMi6LH4dfhr-YQHOyl5CXUU,63175
-odoo_addon_fastapi-16.0.0.0.3.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-odoo_addon_fastapi-16.0.0.0.3.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo_addon_fastapi-16.0.0.0.3.dist-info/RECORD,,
+odoo_addon_fastapi-16.0.0.0.4.dist-info/METADATA,sha256=EmATpP0mBMcokY_4Ivj1R4GeSkAY0rHIQm_HUboGsk0,64841
+odoo_addon_fastapi-16.0.0.0.4.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+odoo_addon_fastapi-16.0.0.0.4.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo_addon_fastapi-16.0.0.0.4.dist-info/RECORD,,
```

